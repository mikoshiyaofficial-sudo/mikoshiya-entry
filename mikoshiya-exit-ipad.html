<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ãƒŸã‚³ã‚·ãƒ¤ç¥­ã‚Šã®å¾Œ</title>

<style>
body{
  text-align:center;
  font-family:sans-serif;
  background:#f4f4f4;
}

h1{ margin-top:20px; }
h2{ color:#ff4d4d; }

video{
  width:90%;
  max-width:480px;
  border-radius:20px;
  border:5px solid #ff4d4d;
}

#msg{
  font-size:20px;
  margin:15px;
}

button{
  padding:14px 20px;
  border-radius:10px;
  border:none;
  background:#333;
  color:#fff;
  font-size:16px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

</head>
<body>

<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
<h2>ç¥­ã‚Šã®å¾Œ</h2>

<video id="video" playsinline></video>
<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>

/* ===== è¨­å®š ===== */
const scriptUrl = "ã“ã“ã«GASã®URL";
const token     = "MIKOSHIYA_2026";
const device    = "mikoshiya-ipad-exit";
const mode      = "OUT";

/* ===== DOM ===== */
const msg       = document.getElementById("msg");
const video     = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");

/* ===== éŸ³ ===== */
const soundOut = new Audio("out.mp3");
let audioUnlocked = false;

enableBtn.addEventListener("click", async () => {
  try{
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    audioUnlocked = true;
    enableBtn.style.display = "none";
    msg.textContent = "éŸ³OKï¼QRã‚’ã‹ã–ã—ã¦ã­";
  }catch(e){
    msg.textContent = "éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
});

/* ===== ãƒ­ãƒƒã‚¯åˆ¶å¾¡ ===== */
const OK_LOCK_MS = 20000;
let lockUntil = 0;
let sending   = false;

/* ===== ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:{ ideal:"environment" } }
})
.then(stream=>{
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(scan);
})
.catch(()=>{
  msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“";
});

/* ===== QRèª­ã¿å–ã‚Š ===== */
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

function scan(){

  if(sending || Date.now() < lockUntil){
    requestAnimationFrame(scan);
    return;
  }

  if(typeof jsQR !== "function"){
    msg.textContent = "QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼";
    requestAnimationFrame(scan);
    return;
  }

  if(!video.videoWidth || !video.videoHeight){
    requestAnimationFrame(scan);
    return;
  }

  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  const code = jsQR(imageData.data, imageData.width, imageData.height, {
    inversionAttempts: "attemptBoth"
  });

  if(code && code.data){
    send(code.data.trim());
    return;
  }

  requestAnimationFrame(scan);
}

/* ===== é€ä¿¡ ===== */
async function send(id){

  sending = true;
  msg.textContent = id + " ã•ã‚“ ç¥­ã‚Šã®å¾Œé€ä¿¡ä¸­...";

  try{

    const url =
      scriptUrl +
      "?id=" + encodeURIComponent(id) +
      "&mode=" + mode +
      "&token=" + encodeURIComponent(token) +
      "&device=" + encodeURIComponent(device) +
      "&_=" + Date.now();

    const res = await fetch(url,{ cache:"no-store" });
    if(!res.ok) throw new Error();

    msg.textContent = id + " ã•ã‚“ ç¥­ã‚Šã®å¾ŒOKï¼";
    lockUntil = Date.now() + OK_LOCK_MS;

    if(audioUnlocked){
      soundOut.currentTime = 0;
      soundOut.play();
    }

  }catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
  }

  setTimeout(()=>{
    sending = false;
    requestAnimationFrame(scan);
  },800);
}

/* ===== ãƒ­ãƒƒã‚¯è¡¨ç¤º ===== */
setInterval(()=>{
  if(lockUntil > Date.now()){
    const sec = Math.ceil((lockUntil - Date.now())/1000);
    msg.textContent = "å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨ " + sec + " ç§’ï¼‰";
  }
},500);

</script>
</body>
</html>
