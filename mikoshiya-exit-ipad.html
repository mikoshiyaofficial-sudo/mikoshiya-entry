<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŸã‚³ã‚·ãƒ¤ ç¥­ã‚Šã®å¾Œ</title>

  <style>
    body{
      text-align:center;
      font-family:sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:0;
    }
    h1{ margin-top:20px; }
    h2{ color:#ff4d4d; margin-top:6px; }

    video{
      width:90%;
      max-width:520px;
      border-radius:20px;
      border:5px solid #ff4d4d;
      background:#000;
    }
    #msg{
      font-size:20px;
      margin:15px 10px;
      min-height:28px;
      word-break: break-word;
    }
    button{
      padding:14px 20px;
      border-radius:10px;
      border:none;
      background:#333;
      color:#fff;
      font-size:16px;
      margin-bottom:10px;
    }
    .small{
      font-size:12px;
      opacity:.7;
      margin-top:6px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
  <h2>ç¥­ã‚Šã®å¾Œ</h2>

  <video id="video" playsinline muted></video>
  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div class="small" id="debug"></div>

<script>
/* ========= è¨­å®š =========
  å¿…ãšã“ã‚Œã‚’ã€Œscript.google.com/macros/s/.../execã€ã«ã™ã‚‹ï¼ˆgoogleusercontent ã®æ–¹ã¯ä½¿ã‚ãªã„ï¼‰
*/
const scriptUrl = "https://script.google.com/macros/s/AKfycbzehzKlAN_JSFlXH1eavYHcTPSOMulrwdzXT91NWhMB45c2f-6PPSDCT9RE4wY0U9roKg/exec";
const token     = "MIKOSHIYA_2026";
const device    = "mikoshiya-ipad-exit";
const mode      = "OUT";  // ç¥­ã‚Šã®å¾Œ = OUT

/* ========= DOM ========= */
const msg       = document.getElementById("msg");
const video     = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");
const debug     = document.getElementById("debug");

/* ========= éŸ³ ========= */
const soundOut = new Audio("out.mp3");
let audioUnlocked = false;

enableBtn.addEventListener("click", async () => {
  try{
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    audioUnlocked = true;
    enableBtn.style.display = "none";
    msg.textContent = "éŸ³OKï¼QRã‚’ã‹ã–ã—ã¦ã­";
  }catch(e){
    msg.textContent = "âš ï¸ éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
});

/* ========= ãƒ­ãƒƒã‚¯åˆ¶å¾¡ ========= */
const OK_LOCK_MS = 20000;  // OKå¾Œ20ç§’ã¯å—ä»˜ãƒ­ãƒƒã‚¯
let lockUntil = 0;
let sending   = false;

/* ========= ã‚«ãƒ¡ãƒ©èµ·å‹• ========= */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
    requestAnimationFrame(scan);
  }catch(e){
    msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆè¨±å¯/åˆ¶é™/ä»–ã‚¢ãƒ—ãƒªä½¿ç”¨ä¸­ã‚’ç¢ºèªï¼‰";
    debug.textContent = String(e && e.message ? e.message : e);
  }
}
startCamera();

/* ========= QRèª­ã¿å–ã‚Š ========= */
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

function scan(){
  if(sending || Date.now() < lockUntil){
    requestAnimationFrame(scan);
    return;
  }

  if(typeof jsQR !== "function"){
    msg.textContent = "QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼";
    requestAnimationFrame(scan);
    return;
  }

  if(!video.videoWidth || !video.videoHeight){
    requestAnimationFrame(scan);
    return;
  }

  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  const code = jsQR(imageData.data, imageData.width, imageData.height, {
    inversionAttempts: "attemptBoth"
  });

  if(code && code.data){
    send(code.data.trim());
    return;
  }

  requestAnimationFrame(scan);
}

/* ========= é€ä¿¡ ========= */
function buildUrl(base, params){
  const sep = base.includes("?") ? "&" : "?";
  const qs = Object.entries(params)
    .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
    .join("&");
  return base + sep + qs;
}

async function send(raw){
  sending = true;

  // QRãŒã€ŒIDãã®ã‚‚ã®ã€ã˜ã‚ƒãªã URL ã®å ´åˆã«å‚™ãˆã¦ id ã‚’æŠ½å‡º
  let id = (raw || "").trim();
  try{
    if(id.startsWith("http")){
      const u = new URL(id);
      id = (u.searchParams.get("id") || "").trim() || id;
    }
  }catch(_){}

  msg.textContent = `${id} ã•ã‚“ é€ä¿¡ä¸­...`;

  try{
    const url = buildUrl(scriptUrl, {
      id, mode,
      token,
      device,
      _: Date.now() // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
    });

    debug.textContent = url; // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé‚ªé­”ãªã‚‰æ¶ˆã—ã¦OKï¼‰

    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text(); // JSONã§ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚æ‹¾ã†

    if(!res.ok){
      throw new Error(`HTTP ${res.status}: ${text}`);
    }

    // GASãŒJSONè¿”ã™å‰æï¼ˆé•ã£ã¦ã‚‚ text ã‚’è¡¨ç¤ºã™ã‚‹ï¼‰
    let data = null;
    try{ data = JSON.parse(text); }catch(_){}

    if(data && data.ok === true){
      
     msg.innerHTML =
  "<div style='font-size:28px;font-weight:bold'>" + id + " ã•ã‚“</div>" +
  "<div style='font-size:18px;margin-top:5px'>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>" +
  "<div style='font-size:24px;margin-top:10px'>åˆ©ç”¨æ™‚é–“ï¼š" + data.minutes + " åˆ†</div>" +
  "<div style='font-size:36px;color:#ff4d4d;margin-top:10px'>æ–™é‡‘ï¼š" + data.amount + " å††</div>"; 

      
      lockUntil = Date.now() + OK_LOCK_MS;

      if(audioUnlocked){
        soundOut.currentTime = 0;
        soundOut.play();
      }
    }else{
      const reason = (data && data.message) ? data.message : text;
      throw new Error(reason || "unknown");
    }

  }catch(e){
    msg.textContent = `é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­`;
    debug.textContent = `ERROR: ${String(e && e.message ? e.message : e)}`;
  }

  setTimeout(()=>{
    sending = false;
    requestAnimationFrame(scan);
  }, 800);
}

</script>

</body>
</html> 
