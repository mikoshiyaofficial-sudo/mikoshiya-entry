<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ï¼ˆé€€å®¤å°‚ç”¨ï¼‰</title>

<style>
body{
  font-family:sans-serif;
  text-align:center;
  background:#fff;
}

h1{
  margin-top:30px;
}

#video{
  width:80%;
  max-width:500px;
  margin:20px auto;
  border-radius:20px;
  border:6px solid #ff4d4d;
  background:#000;
}

#msg{
  font-size:20px;
  margin:15px;
}

button{
  padding:14px 20px;
  border-radius:10px;
  border:none;
  background:#333;
  color:#fff;
  font-size:16px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  
</head>

<body>

<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>

<h2 style="color:#ff4d4d;">é€€å®¤</h2>

<video id="video" playsinline></video>

<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>

<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>

/* ====== è¨­å®šï¼ˆã“ã“ã ã‘å¤‰æ›´OKï¼‰ ====== */
const scriptUrl = "https://script.google.com/macros/s/AKfycbwcv3zkiuE3SspSdpXTBK6cJG4xmxXnolWfG2-nyjuOa0qwSEKAtNItD-wuKOwRBdDtww/exec";
const token = "MIKOSHIYA_2026";
const device = "mikoshiya-ipad-exit";

/* ====== DOM ====== */
const msg = document.getElementById("msg");
const video = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");

/* ====== ãƒ¢ãƒ¼ãƒ‰å›ºå®š ====== */
const mode = "OUT";

/* ====== QRåˆ¶å¾¡ ====== */
const COOLDOWN_MS = 3000;
const OK_LOCK_MS = 20000;

let lockUntil = 0;
let lastId = "";
let lastAt = 0;
let sending = false;
let audioUnlocked = false;
let lockTimer = null;

/* ====== éŸ³ ====== */
const soundOut = new Audio("exit.mp3");
soundOut.preload = "auto";

enableBtn.addEventListener("pointerdown", async (e) => {
  e.preventDefault();
  try {
    // iPadå¯¾ç­–ï¼šä¸€ç¬ãƒŸãƒ¥ãƒ¼ãƒˆå†ç”Ÿâ†’åœæ­¢ã§â€œè§£éŒ â€
    soundOut.muted = true;
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    soundOut.muted = false;

    audioUnlocked = true;
    msg.textContent = "âœ… éŸ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ";
    enableBtn.style.display = "none";
  } catch (e) {
    console.log(e);
    msg.textContent = "âš ï¸ éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
}, { passive: false });
  
/* ====== ã‚«ãƒ¡ãƒ©èµ·å‹• ====== */
navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment"} } })
.then(stream=>{
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(scan);
})
.catch(()=>{
  msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“";
});

/* ====== QRèª­ã¿å–ã‚Šï¼ˆä»®ï¼‰ ====== */
function scan(){
  // â˜…ã“ã“ã¯å®Ÿéš›ã®QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å–å¾—
  requestAnimationFrame(scan);
}

/* ====== é€ä¿¡å‡¦ç† ====== */
async function send(id){

  sending = true;

  msg.textContent = `${id} ã•ã‚“ é€€å®¤ é€ä¿¡ä¸­...`;

  try{
    const url =
      `${scriptUrl}?id=${encodeURIComponent(id)}` +
      `&mode=${mode}` +
      `&token=${encodeURIComponent(token)}` +
      `&device=${encodeURIComponent(device)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url,{ cache:"no-store" });
    if(!res.ok) throw new Error();

    msg.textContent = `${id} ã•ã‚“ é€€å®¤ OKï¼`;

    lockUntil = Date.now() + OK_LOCK_MS;
    startLockTimer();

    if(audioUnlocked){
      soundOut.currentTime = 0;
      soundOut.play();
    }

  }catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—â€¦ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
    lastAt = 0;
    lockUntil = 0;
  }finally{
    setTimeout(()=> sending=false,600);
  }
}

/* ====== ãƒ­ãƒƒã‚¯ã‚«ã‚¦ãƒ³ãƒˆ ====== */
function startLockTimer(){

  if(lockTimer) return;

  lockTimer = setInterval(()=>{

    if(Date.now() < lockUntil){
      const sec = Math.max(0, Math.floor((lockUntil - Date.now())/1000));
      msg.textContent = `å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨${sec}ç§’ï¼‰`;
    }
    else if(lockUntil !== 0){
      lockUntil = 0;
      msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
    }

  },500);
}

</script>
</body>
</html>
