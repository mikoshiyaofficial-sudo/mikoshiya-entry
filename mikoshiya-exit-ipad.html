<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒŸã‚³ã‚·ãƒ¤ é€€å®¤</title>

<style>
body{
  text-align:center;
  font-family:sans-serif;
  background:#f8f8f8;
}

h1{
  margin-top:20px;
}

video{
  width:80%;
  max-width:500px;
  border:6px solid #ff4d4d;
  border-radius:20px;
}

#msg{
  font-size:20px;
  margin:15px;
}

button{
  padding:14px 20px;
  border-radius:10px;
  border:none;
  background:#333;
  color:#fff;
  font-size:16px;
}
</style>

<!-- QRãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

</head>

<body>

<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
<h2 style="color:#ff4d4d;">é€€å®¤</h2>

<video id="video" playsinline></video>
<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>

<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>

/* ===== è¨­å®šï¼ˆã“ã“ã ã‘å¤‰æ›´OKï¼‰ ===== */
const scriptUrl = "ã‚ãªãŸã®GASã®URLã‚’ã“ã“ã«è²¼ã‚‹";
const token = "MIKOSHIYA_2026";
const device = "mikoshiya-ipad-exit";

/* ===== DOM ===== */
const msg = document.getElementById("msg");
const video = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");

/* ===== çŠ¶æ…‹ç®¡ç† ===== */
let audioUnlocked = false;
let sending = false;
let lockUntil = 0;
const OK_LOCK_MS = 20000;

/* ===== éŸ³ ===== */
const soundOut = new Audio("out.mp3");

enableBtn.addEventListener("click", async () => {
  try{
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    audioUnlocked = true;
    enableBtn.style.display = "none";
  }catch(e){
    msg.textContent = "âš  éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
});

/* ===== ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:{ ideal:"environment" } }
})
.then(stream=>{
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(scan);
})
.catch(()=>{
  msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“";
});

/* ===== QRèª­ã¿å–ã‚Š ===== */
function scan() {
  // é€ä¿¡ä¸­ or ãƒ­ãƒƒã‚¯ä¸­ã¯èª­ã¾ãªã„ï¼ˆè¡¨ç¤ºã ã‘æ›´æ–°ï¼‰
  if (sending || Date.now() < lockUntil) {
    requestAnimationFrame(scan);
    return;
  }

  // æ˜ åƒãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…ã¤
  if (video.readyState !== video.HAVE_ENOUGH_DATA) {
    requestAnimationFrame(scan);
    return;
  }

  // canvasã‚µã‚¤ã‚ºã¯ä¸€åº¦ã ã‘ã‚»ãƒƒãƒˆï¼ˆå®‰å®šåŒ–ï¼‰
  if (!canvas.width || !canvas.height) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  // â˜…åè»¢å¯¾å¿œã‚’å…¥ã‚Œã‚‹ï¼ˆiPadã§åŠ¹ãã“ã¨ã‚ã‚‹ï¼‰
  const code =
    jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });

  if (code && code.data) {
    const id = code.data.trim();

    // åŒã˜QRé€£æ‰“é˜²æ­¢ï¼ˆCOOLDOWN_MSï¼‰
    const now = Date.now();
    if (id === lastId && (now - lastAt) < COOLDOWN_MS) {
      requestAnimationFrame(scan);
      return;
    }

    lastId = id;
    lastAt = now;

    send(id); // sendã®ä¸­ã§sending/lockUntilã‚’ç®¡ç†
  }

  requestAnimationFrame(scan);
}

/* ===== é€ä¿¡å‡¦ç† ===== */
async function send(id){

  if(sending) return;
  if(Date.now() < lockUntil) return;

  sending = true;
  msg.textContent = id + " ã•ã‚“ é€€å®¤é€ä¿¡ä¸­...";

  try{

    const url =
      scriptUrl +
      "?id=" + encodeURIComponent(id) +
      "&mode=OUT" +
      "&token=" + encodeURIComponent(token) +
      "&device=" + encodeURIComponent(device) +
      "&_=" + Date.now();

    const res = await fetch(url,{ cache:"no-store" });

    if(!res.ok) throw new Error();

    msg.textContent = id + " ã•ã‚“ é€€å®¤OKï¼";

    lockUntil = Date.now() + OK_LOCK_MS;

    if(audioUnlocked){
      soundOut.currentTime = 0;
      soundOut.play();
    }

  }catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
  }

  setTimeout(()=>{
    sending = false;
    requestAnimationFrame(scan);
  },800);
}

/* ===== ãƒ­ãƒƒã‚¯è¡¨ç¤ºæ›´æ–° ===== */
setInterval(()=>{
  if(lockUntil > Date.now()){
    const sec = Math.ceil((lockUntil - Date.now())/1000);
    msg.textContent = "å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨" + sec + "ç§’ï¼‰";
  }
},500);

</script>

</body>
</html>
