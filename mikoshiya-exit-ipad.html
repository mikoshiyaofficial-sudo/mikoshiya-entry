<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ï½œç¥­ã‚Šã®å¾Œ</title>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --red:#d61f2c;
      --bg:#f4f4f6;
      --text:#222;
    }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 30px;
      text-align:center;
    }
    h1{
      margin: 18px 0 8px;
      font-size: 44px;
      letter-spacing: 0.04em;
      font-weight: 800;
    }
    h2{
      margin: 0 0 12px;
      font-size: 30px;
      color: var(--red);
      font-weight: 800;
    }
    .ver{
      position: fixed;
      top: 10px;
      right: 14px;
      font-size: 14px;
      opacity: .55;
      user-select:none;
    }
    .frame{
      margin: 10px auto 18px;
      width: min(92vw, 980px);
      aspect-ratio: 4 / 3;
      border: 6px solid var(--red);
      border-radius: 18px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      transform: translateZ(0);
    }
    #msg{
      font-size: 32px;
      font-weight: 800;
      margin: 10px 0 14px;
    }
    #debug{
      margin-top: 10px;
      font-size: 14px;
      opacity: .55;
      white-space: pre-wrap;
    }
    #btnSound{
      margin: 8px auto 0;
      padding: 16px 26px;
      font-size: 22px;
      font-weight: 800;
      border: none;
      border-radius: 14px;
      background: #111;
      color: #fff;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      width: min(520px, 86vw);
    }
    #btnSound.ok{
      background: #2a7a2a;
    }
    .hint{
      margin-top: 8px;
      font-size: 16px;
      opacity: .65;
    }

    /* iPadç¸¦æ¨ªã®ä½™ç™½æœ€é©åŒ– */
    @media (max-width: 820px){
      h1{font-size: 36px;}
      h2{font-size: 26px;}
      #msg{font-size: 26px;}
      .frame{aspect-ratio: 3 / 4;}
    }
  </style>
</head>

<body>
  <div class="ver">v2.5</div>

  <div class="wrap">
    <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
    <h2>ç¥­ã‚Šã®å¾Œ</h2>

    <div class="frame">
      <video id="video" playsinline muted></video>
    </div>

    <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>

    <button id="btnSound">ğŸ”‡ éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
    <div class="hint">â€»iPadã¯æœ€åˆã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãªã„ã¨éŸ³ãŒé³´ã‚Šã¾ã›ã‚“</div>

    <div id="debug"></div>
  </div>

<script>
/* ================= è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰ ================= */
const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec";
const token     = "MIKOSHIYA_2026";
const device    = "mikoshiya-ipad-exit";   // OUTç«¯æœ«å
const mode      = "OUT";                   // ç¥­ã‚Šã®å¾Œ = OUT
/* ========================================================= */

/* ================= å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ================= */
const OK_LOCK_MS     = 3500;   // æˆåŠŸè¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“ â†’ è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸°
const FAIL_LOCK_MS   = 1500;   // å¤±æ•—è¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“
const SCAN_INTERVAL_MS = 120;  // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”ï¼ˆè² è·èª¿æ•´ï¼‰
const DUP_GUARD_MS   = 20000;  // äºŒé‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ï¼ˆ20ç§’ï¼‰
/* ================================================= */

/* ================= DOM ================= */
const video    = document.getElementById("video");
const msg      = document.getElementById("msg");
const debug    = document.getElementById("debug");
const btnSound = document.getElementById("btnSound");
/* ====================================== */

/* ================= çŠ¶æ…‹ ================= */
let sending = false;
let lockUntil = 0;
let lastId = "";
let lastScanTime = 0;
let soundEnabled = false;

/* canvas */
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

/* soundsï¼ˆåŒéšå±¤ã« takeok.mp3 / error.mp3 ã‚’ç½®ãï¼‰ */
const okSound   = new Audio("takeok.mp3");
const failSound = new Audio("error.mp3");

/* iOSå‘ã‘ï¼šéŸ³ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ */
async function enableSound(){
  try{
    okSound.currentTime = 0;
    await okSound.play().catch(()=>{});
    okSound.pause();
    okSound.currentTime = 0;

    failSound.currentTime = 0;
    await failSound.play().catch(()=>{});
    failSound.pause();
    failSound.currentTime = 0;

    soundEnabled = true;
    btnSound.textContent = "âœ… éŸ³æœ‰åŠ¹";
    btnSound.classList.add("ok");
  }catch(e){
    // å¤±æ•—ã—ã¦ã‚‚ãƒœã‚¿ãƒ³ã¯æ®‹ã—ã¦å†ãƒˆãƒ©ã‚¤å¯èƒ½ã«ã™ã‚‹
  }
}
btnSound.addEventListener("click", enableSound, { passive:true });

/* ã‚«ãƒ¡ãƒ©é–‹å§‹ */
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;
  await video.play();
}

/* QRèª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ— */
let lastScanTick = 0;
function scanLoop(t){
  requestAnimationFrame(scanLoop);

  // ãƒ­ãƒƒã‚¯ä¸­ã¯è¡¨ç¤ºã ã‘ç¶­æŒ
  if (Date.now() < lockUntil) return;

  // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”åˆ¶å¾¡
  if (t - lastScanTick < SCAN_INTERVAL_MS) return;
  lastScanTick = t;

  if (!video.videoWidth || !video.videoHeight) return;

  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
  if (!code || !code.data) return;

  const id = String(code.data).trim();
  if (!id) return;

  // äºŒé‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ï¼ˆ20ç§’ï¼‰
  const now = Date.now();
  if (id === lastId && (now - lastScanTime) < DUP_GUARD_MS) {
    return;
  }
  lastId = id;
  lastScanTime = now;

  sendQR(id);
}

/* GASã¸é€ä¿¡ */
async function sendQR(id){
  if (sending) return;
  sending = true;

  msg.textContent = "é€šä¿¡ä¸­â€¦";
  debug.textContent = "";

  try{
    const url = `${scriptUrl}?id=${encodeURIComponent(id)}&mode=${encodeURIComponent(mode)}&token=${encodeURIComponent(token)}&device=${encodeURIComponent(device)}`;
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();

    if (data && data.ok){
      // OUTãªã®ã§ minutes/amount ã‚’è¦‹ã›ã‚‹
      const name = (data.name || id);
      const minutes = Number(data.minutes || 0);
      const amount  = Number(data.amount  || 0);

      msg.textContent =
        `${name} ã•ã‚“\n` +
        `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n` +
        `åˆ©ç”¨æ™‚é–“ï¼š${minutes} åˆ†\n` +
        `æ–™é‡‘ï¼š${amount} å††`;

      if (soundEnabled){
        try{ failSound.pause(); failSound.currentTime = 0; }catch(e){}
        try{ okSound.currentTime = 0; await okSound.play().catch(()=>{}); }catch(e){}
      }

      lockUntil = Date.now() + OK_LOCK_MS;

    }else{
      msg.textContent = (data && data.message) ? data.message : "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";

      if (soundEnabled){
        try{ okSound.pause(); okSound.currentTime = 0; }catch(e){}
        try{ failSound.currentTime = 0; await failSound.play().catch(()=>{}); }catch(e){}
      }

      lockUntil = Date.now() + FAIL_LOCK_MS;
    }

  }catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
    debug.textContent = "ERROR: " + (e && e.message ? e.message : String(e));
    lockUntil = Date.now() + FAIL_LOCK_MS;
  }finally{
    // è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸°ï¼šãƒ­ãƒƒã‚¯æ™‚é–“ãŒçµ‚ã‚ã£ãŸã‚‰æ¡ˆå†…æ–‡ã«æˆ»ã™
    setTimeout(()=>{
      sending = false;
      if (Date.now() >= lockUntil){
        msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
      }
    }, Math.max(OK_LOCK_MS, FAIL_LOCK_MS) + 50);
  }
}

/* èµ·å‹• */
(async ()=>{
  try{
    await startCamera();
    requestAnimationFrame(scanLoop);
  }catch(e){
    msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ï¼ˆæ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    debug.textContent = "ERROR: " + (e && e.message ? e.message : String(e));
  }
})();
</script>
</body>
</html>
