<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒŸã‚³ã‚·ãƒ¤ç¥­ã‚Šã®å¾Œ</title>

<style>
body{
  text-align:center;
  font-family:sans-serif;
  background:#f4f4f4;
}
h1{ margin-top:20px; }
h2{ color:#ff4d4d; }

video{
  width:90%;
  max-width:500px;
  border-radius:20px;
  border:5px solid #ff4d4d;
  background:#000; /* æ˜ åƒå‡ºã‚‹ã¾ã§çœŸã£ç™½å›é¿ */
}

#msg{
  font-size:20px;
  margin:15px;
}

button{
  padding:14px 20px;
  border-radius:10px;
  border:none;
  background:#333;
  color:#fff;
  font-size:16px;
}
</style>

<!-- QRãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
<h2>ç¥­ã‚Šã®å¾Œ</h2>

<!-- iPad Safariå®‰å®šåŒ–ï¼šautoplay + muted -->
<video id="video" playsinline autoplay muted></video>

<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/* ===== è¨­å®šï¼ˆã“ã“ã ã‘å¤‰æ›´OKï¼‰ ===== */
const scriptUrl = "https://script.google.com/macros/s/AKfycbwcv3zkiuE3SspSdpXTBK6cJG4xmxXnolWfG2-nyjuOa0qwSEKAtNItD-wuKOwRBdDtww/exec";
const token     = "MIKOSHIYA_2026";
const device    = "mikoshiya-ipad-exit";

/* ===== DOM ===== */
const msg       = document.getElementById("msg");
const video     = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");

/* ===== ãƒ¢ãƒ¼ãƒ‰å›ºå®š ===== */
const mode = "OUT";

/* ===== QRåˆ¶å¾¡ ===== */
const COOLDOWN_MS = 3000;
const OK_LOCK_MS  = 20000;

let lockUntil = 0;
let lastId    = "";
let lastAt    = 0;
let sending   = false;
let audioUnlocked = false;

/* ===== éŸ³ ===== */
const soundOut = new Audio("out.mp3");

enableBtn.addEventListener("click", async () => {
  try{
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    audioUnlocked = true;
    enableBtn.style.display = "none";
  }catch(e){
    msg.textContent = "âš  éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
});

/* ===== ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:{ ideal:"environment" } }
})
.then(async (stream)=>{
  video.srcObject = stream;

  // iPad Safariå¯¾ç­–
  video.muted = true;
  video.setAttribute("playsinline", "");
  video.setAttribute("autoplay", "");

  try{
    await video.play();
  }catch(e){
    // ã“ã“ã§æ­¢ã¾ã‚‹ç«¯æœ«ã‚‚ã‚ã‚‹ï¼ˆãã®å ´åˆã¯å†èª­ã¿è¾¼ã¿ã‚„æ¨©é™è¦‹ç›´ã—ï¼‰
  }

  // msg.textContent = "âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•OK"; // ãƒ‡ãƒãƒƒã‚°ã—ãŸã„æ™‚ã ã‘ON
  requestAnimationFrame(scan);
})
.catch(()=>{
  msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆæ¨©é™/HTTPS/è¨­å®šã‚’ç¢ºèªï¼‰";
});

/* ===== QRèª­ã¿å–ã‚Š ===== */
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

function scan() {
  // é€ä¿¡ä¸­ or ãƒ­ãƒƒã‚¯ä¸­ã¯èª­ã¾ãªã„
  if (sending || Date.now() < lockUntil) {
    requestAnimationFrame(scan);
    return;
  }

  // jsQRãŒèª­ã¿è¾¼ã‚ã¦ã‚‹ã‹
  if (typeof jsQR !== "function") {
    msg.textContent = "âŒ jsQRãŒèª­ã¿è¾¼ã‚ã¦ãªã„ï¼ˆscriptã‚¿ã‚°ç¢ºèªï¼‰";
    requestAnimationFrame(scan);
    return;
  }

  // æ˜ åƒæº–å‚™å¾…ã¡
  if (!video.videoWidth || !video.videoHeight) {
    requestAnimationFrame(scan);
    return;
  }

  // ===== è§£æã¯ã€Œä¸­å¤®ã ã‘åˆ‡ã‚ŠæŠœãã€ =====
  const sw = video.videoWidth;
  const sh = video.videoHeight;

  const crop = 0.65; // 0.55ã€œ0.8ã§èª¿æ•´
  const cw = Math.floor(sw * crop);
  const ch = Math.floor(sh * crop);
  const sx = Math.floor((sw - cw) / 2);
  const sy = Math.floor((sh - ch) / 2);

  canvas.width  = cw;
  canvas.height = ch;

  try{
    ctx.drawImage(video, sx, sy, cw, ch, 0, 0, cw, ch);

    const imageData = ctx.getImageData(0, 0, cw, ch);

    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "attemptBoth",
    });

    if (code && code.data) {
      const id = code.data.trim();

      // åŒã˜QRé€£æ‰“é˜²æ­¢ï¼ˆCOOLDOWN_MSï¼‰
      const now = Date.now();
      if (id === lastId && (now - lastAt) < COOLDOWN_MS) {
        requestAnimationFrame(scan);
        return;
      }
      lastId = id;
      lastAt = now;

      send(id);
      return;
    }
  }catch(e){
    msg.textContent = "âŒ QRå‡¦ç†ã§ä¾‹å¤–: " + (e && e.message ? e.message : e);
  }

  requestAnimationFrame(scan);
}

/* ===== é€ä¿¡å‡¦ç† ===== */
async function send(id){
  if(sending) return;
  if(Date.now() < lockUntil) return;

  sending = true;
  msg.textContent = id + " ã•ã‚“ ç¥­ã‚Šã®å¾Œé€ä¿¡ä¸­...";

  try{
    const url =
      scriptUrl +
      "?id=" + encodeURIComponent(id) +
      "&mode=" + mode +
      "&token=" + encodeURIComponent(token) +
      "&device=" + encodeURIComponent(device) +
      "&_=" + Date.now();

    const res = await fetch(url,{ cache:"no-store" });
    if(!res.ok) throw new Error();

    msg.textContent = id + " ã•ã‚“ ç¥­ã‚Šã®å¾ŒOKï¼";
    lockUntil = Date.now() + OK_LOCK_MS;

    if(audioUnlocked){
      soundOut.currentTime = 0;
      soundOut.play();
    }

  }catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
  }

  setTimeout(()=>{
    sending = false;
    requestAnimationFrame(scan);
  },800);
}

/* ===== ãƒ­ãƒƒã‚¯è¡¨ç¤ºæ›´æ–° ===== */
setInterval(()=>{
  if(lockUntil > Date.now()){
    const sec = Math.ceil((lockUntil - Date.now())/1000);
    msg.textContent = "å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨ " + sec + " ç§’ï¼‰";
  }
},500);
</script>

</body>
</html>
