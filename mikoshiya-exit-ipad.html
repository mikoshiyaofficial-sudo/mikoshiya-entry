async function send(raw){

  sending = true;

  // ① QRが「IDそのもの」じゃなくURLだった場合に備えてID抽出
  let id = (raw || "").trim();
  try{
    if(id.startsWith("http")){
      const u = new URL(id);
      id = (u.searchParams.get("id") || "").trim() || id; // id= があればそれを使う
    }
  }catch(e){}

  msg.textContent = id + " さん 祭りの後送信中...";

  try{
    // ② scriptUrl に ? がある/ない どっちでも壊れないようにする
    const sep = scriptUrl.includes("?") ? "&" : "?";

    const url =
      scriptUrl + sep +
      "id=" + encodeURIComponent(id) +
      "&mode=" + encodeURIComponent(mode) +
      "&token=" + encodeURIComponent(token) +
      "&device=" + encodeURIComponent(device) +
      "&_=" + Date.now();

    const res = await fetch(url, { cache:"no-store" });

    // ③ ここが重要：GASの返すJSONを読む（ok:false なら理由を表示）
    const text = await res.text();
    let data = null;
    try{ data = JSON.parse(text); }catch(e){}

    if(!res.ok){
      throw new Error("HTTP " + res.status);
    }
    if(!data || data.ok !== true){
      const m = (data && data.message) ? data.message : text;
      throw new Error(m);
    }

    msg.textContent = id + " さん 祭りの後OK！";
    lockUntil = Date.now() + OK_LOCK_MS;

    if(audioUnlocked){
      soundOut.currentTime = 0;
      soundOut.play();
    }

  }catch(e){
    msg.textContent = "通信失敗: " + (e.message || "unknown");
  }

  setTimeout(()=>{
    sending = false;
    requestAnimationFrame(scan);
  },800);
}
