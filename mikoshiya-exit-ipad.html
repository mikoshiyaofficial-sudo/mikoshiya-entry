<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</title>

  <style>
    :root{
      --red:#d61f2c;
      --bg:#f4f4f6;
      --text:#222;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 18px 30px;
      text-align:center;
    }
    h1{
      margin:18px 0 8px;
      font-size:44px;
      letter-spacing:0.04em;
      font-weight:800;
    }
    h2{
      margin:0 0 12px;
      font-size:30px;
      font-weight:800;
      color:var(--red);
    }

    /* =========================
       â˜…è¿½åŠ ï¼ˆã“ã“ã ã‘è¿½åŠ ï¼‰ï¼šãƒ‡ã‚«ã™ãæŠ‘åˆ¶
       â€»ä»–ã¯å¤‰æ›´ãªã—
       ========================= */
    .frame{
      margin: 10px auto 16px;
      width: min(92vw, 980px);
      height: min(62vh, 620px); /* â† iPadã§ãƒ‡ã‚«ããªã‚Šã™ãã‚‹ã®ã‚’æŠ‘åˆ¶ */
      border: 6px solid var(--red);
      border-radius: 18px;
      overflow: hidden;
      background:#000;
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
    }
    #video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    /* â˜…è¿½åŠ ã“ã“ã¾ã§ */

    #msg{
      margin:10px 0 14px;
      font-size:34px;
      font-weight:800;
    }
    #enableSound{
      display:inline-block;
      width:min(680px, 90vw);
      padding:18px 22px;
      border:0;
      border-radius:14px;
      background:#111;
      color:#fff;
      font-size:28px;
      font-weight:800;
    }
    #enableSound[disabled]{
      opacity:.55;
    }
    #debug{
      margin-top:10px;
      font-size:14px;
      opacity:.65;
      white-space:pre-wrap;
      word-break:break-all;
    }
    .small{
      font-size:14px;
      opacity:.65;
      margin-top:10px;
      white-space:pre-wrap;
      word-break:break-all;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
    <h2>ç¥­ã‚Šã®å¾Œ</h2>

    <div class="frame">
      <video id="video" playsinline muted></video>
    </div>

    <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
    <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
    <div class="small" id="debug"></div>
  </div>

  <script>
    /* ========= è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰ ========= */
    const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec";
    const token     = "MIKOSHIYA_2026";
    const device    = "mikoshiya-ipad-exit";
    const mode      = "OUT";   // ç¥­ã‚Šã®å¾Œ = OUT

    /* ========= å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ========= */
    const OK_LOCK_MS       = 3500;  // é‡‘é¡è¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“ â†’ è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸°
    const FAIL_LOCK_MS     = 1200;  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    const SCAN_INTERVAL_MS = 120;   // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”ï¼ˆè² è·èª¿æ•´ï¼‰
    const DUP_GUARD_MS     = 2500;  // åŒã˜QRé€£æ‰“é˜²æ­¢

    /* ========= DOM ========= */
    const video    = document.getElementById("video");
    const msg      = document.getElementById("msg");
    const debug    = document.getElementById("debug");
    const btnSound = document.getElementById("enableSound");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    /* ========= çŠ¶æ…‹ ========= */
    let sending = false;
    let lockUntil = 0;
    let lastId = "";
    let lastScanTime = 0;
    let soundEnabled = false;

    /* ========= éŸ³ ========= */
    const okSound   = new Audio("take.mp3");
    const failSound = new Audio("error.mp3");

    btnSound.addEventListener("click", async () => {
      try{
        await okSound.play().catch(()=>{});
        okSound.pause();
        okSound.currentTime = 0;
        soundEnabled = true;
        btnSound.textContent = "âœ… éŸ³æœ‰åŠ¹";
        btnSound.disabled = true;
      }catch(e){
        // iOSã®åˆ¶é™ã§é³´ã‚‰ã›ãªã„å ´åˆãŒã‚ã‚‹
        debug.textContent = "éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—: " + (e && e.message ? e.message : String(e));
      }
    });

    /* ========= ã‚«ãƒ¡ãƒ© ========= */
    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    /* ========= QRé€ä¿¡ ========= */
    async function sendQR(id){
      if (sending) return;
      const now = Date.now();

      // 2é‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
      if (id === lastId && (now - lastScanTime) < DUP_GUARD_MS) return;

      sending = true;
      lastId = id;
      lastScanTime = now;

      msg.textContent = "é€šä¿¡ä¸­â€¦";
      try{
        const res = await fetch(`${scriptUrl}?id=${encodeURIComponent(id)}&mode=${encodeURIComponent(mode)}&token=${encodeURIComponent(token)}&device=${encodeURIComponent(device)}`);
        const data = await res.json();

        if (data.ok){
          // æˆåŠŸè¡¨ç¤ºï¼ˆç¥­ã‚Šã®å¾Œ = é‡‘é¡ã‚‚å‡ºã‚‹ï¼‰
          msg.textContent =
            `${data.id} ã•ã‚“\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\nåˆ©ç”¨æ™‚é–“ï¼š${data.minutes || 0} åˆ†\næ–™é‡‘ï¼š${data.amount || 0} å††`;

          if (soundEnabled) okSound.play().catch(()=>{});
          lockUntil = now + OK_LOCK_MS;
        } else {
          msg.textContent = data.message || "å¤±æ•—";
          if (soundEnabled) failSound.play().catch(()=>{});
          lockUntil = now + FAIL_LOCK_MS;
        }
      }catch(e){
        msg.textContent = "é€šä¿¡å¤±æ•—";
        if (soundEnabled) failSound.play().catch(()=>{});
        lockUntil = now + FAIL_LOCK_MS;
        debug.textContent = String(e);
      } finally {
        sending = false;
      }
    }

    /* ========= ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ— ========= */
    function tick(){
      const now = Date.now();

      // ãƒ­ãƒƒã‚¯ä¸­ã¯ã‚¹ã‚­ãƒ£ãƒ³ã—ãªã„
      if (now < lockUntil){
        requestAnimationFrame(tick);
        return;
      }

      // ãƒ­ãƒƒã‚¯è§£é™¤ â†’ ãƒˆãƒƒãƒ—å¾©å¸°ï¼ˆè¡¨ç¤ºã‚’å…ƒã«æˆ»ã™ï¼‰
      if (msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„") {
        msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
      }

      if (video.readyState >= 2){
        const w = video.videoWidth;
        const h = video.videoHeight;
        if (w && h){
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);

          const imageData = ctx.getImageData(0, 0, w, h);
          const code = jsQR(imageData.data, w, h);
          if (code && code.data){
            sendQR(code.data.trim());
          }
        }
      }

      setTimeout(() => requestAnimationFrame(tick), SCAN_INTERVAL_MS);
    }

    /* ========= èµ·å‹• ========= */
    (async () => {
      try{
        await startCamera();
        tick();
      }catch(e){
        msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—";
        debug.textContent = String(e);
      }
    })();
  </script>
</body>
</html>
