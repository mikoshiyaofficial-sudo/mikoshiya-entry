<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ - ç¥­ã‚Šå‚åŠ </title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --red:#d44747;
      --text:#111;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
      text-align:center;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:22px 12px 8px; }
    h1{ margin:0; font-size:40px; font-weight:900; letter-spacing:.02em; }
    h2{ margin:10px 0 0; font-size:38px; font-weight:1000; color:var(--red); }

    .frame{
      width:min(92vw, 980px);
      aspect-ratio: 4 / 3;
      margin:14px auto 10px;
      border:6px solid var(--red);
      border-radius:16px;
      overflow:hidden;
      background:#111;
      box-sizing:border-box;
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    #msg{
      width:min(92vw, 980px);
      margin:10px auto 0;
      min-height:54px;
      font-size:30px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #sub{
      width:min(92vw, 980px);
      margin:4px auto 0;
      min-height:28px;
      font-size:18px;
      font-weight:800;
      color:#666;
    }

    #enableSound{
      margin:14px auto 8px;
      padding:16px 18px;
      font-size:22px;
      font-weight:900;
      border:0;
      border-radius:14px;
      background:#111;
      color:#fff;
      width:min(70vw, 520px);
    }
    #enableSound[disabled]{ opacity:.55; }

    #ver{
      position:fixed;
      right:10px;
      top:10px;
      font-size:12px;
      color:#888;
      font-weight:800;
    }

    /* ãƒ‡ãƒãƒƒã‚°ï¼ˆå¿…è¦ãªã‚‰ block ã«ï¼‰ */
    #debug{
      display:none;
      width:min(92vw, 980px);
      margin:8px auto 16px;
      font-size:12px;
      color:#666;
      word-break:break-all;
      text-align:left;
    }
  </style>
</head>

<body>
  <div id="ver">v2.5</div>

  <header>
    <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
    <h2>ç¥­ã‚Šå‚åŠ </h2>
  </header>

  <div class="frame">
    <video id="video" playsinline muted></video>
  </div>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <div id="sub"></div>

  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div id="debug"></div>

  <script>
    /********************
     * è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰
     ********************/
    const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec";
    const token  = "MIKOSHIYA_2026";
    const device = "mikoshiya-ipad-entry";
    const mode   = "IN"; // ç¥­ã‚Šå‚åŠ  = IN

    /********************
     * å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     ********************/
    const OK_LOCK_MS       = 3500;   // æˆåŠŸè¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“
    const FAIL_LOCK_MS     = 1500;   // å¤±æ•—è¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“
    const SCAN_INTERVAL_MS = 120;    // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”
    const DUP_GUARD_MS     = 20000;  // 20ç§’ åŒã˜QRé€£æ‰“é˜²æ­¢

    /********************
     * DOM
     ********************/
    const video = document.getElementById("video");
    const msg   = document.getElementById("msg");
    const sub   = document.getElementById("sub");
    const btnSound = document.getElementById("enableSound");
    const debug = document.getElementById("debug");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently:true });

    /********************
     * çŠ¶æ…‹
     ********************/
    let sending = false;
    let lockUntil = 0;
    let lastId = "";
    let lastIdAt = 0;

    /********************
     * éŸ³ï¼šiPadã§ç¢ºå®Ÿã«é³´ã‚‰ã™ï¼ˆAudioContextæ–¹å¼ï¼‰
     ********************/
    let audioCtx = null;
    let soundEnabled = false;

    function beep(type="ok"){
      if(!soundEnabled || !audioCtx) return;
      const now = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      // ok: é«˜ã‚ / ng: ä½ã‚
      osc.frequency.value = (type==="ok") ? 880 : 220;
      osc.type = "sine";

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.16);
    }

    btnSound.addEventListener("click", async ()=>{
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        await audioCtx.resume();
        soundEnabled = true;
        btnSound.textContent = "âœ… éŸ³ æœ‰åŠ¹";
        btnSound.disabled = true;
        beep("ok"); // è§£ç¦ç¢ºèª
      }catch(e){
        // debug.style.display="block";
        debug.textContent = "AUDIO ERROR: " + (e?.message || e);
      }
    });

    /********************
     * ã‚«ãƒ¡ãƒ©èµ·å‹•
     ********************/
    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    /********************
     * QRèª­ã‚€
     ********************/
    function readQR(){
      if(video.readyState < 2) return null;
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h) return null;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);

      const img = ctx.getImageData(0,0,w,h);
      const code = jsQR(img.data, w, h, { inversionAttempts:"attemptBoth" });
      return code ? (code.data || "") : null;
    }

    function extractId(text){
      text = String(text||"").trim();
      if(!text) return "";

      // 1) IDã ã‘ã®QR
      if (/^[A-Za-z0-9_-]{3,}$/.test(text) && !text.includes("http")) return text;

      // 2) URLå‹ã®QRï¼ˆ?id=ï¼‰
      try{
        const u = new URL(text);
        const id = (u.searchParams.get("id") || u.searchParams.get("ID") || "").trim();
        if(id) return id;
      }catch(_){}

      // 3) å¿µã®ãŸã‚ regex
      const m = text.match(/[?&]id=([^&]+)/i);
      return m ? decodeURIComponent(m[1]).trim() : "";
    }

    /********************
     * é€ä¿¡
     ********************/
    async function send(id){
      const now = Date.now();

      // é€šä¿¡ä¸­ or ãƒ­ãƒƒã‚¯ä¸­ã¯ç„¡è¦–
      if(sending || now < lockUntil) return;

      // 20ç§’ åŒä¸€IDã‚¬ãƒ¼ãƒ‰
      if(id === lastId && (now - lastIdAt) < DUP_GUARD_MS) return;

      lastId = id;
      lastIdAt = now;

      sending = true;
      msg.textContent = "é€šä¿¡ä¸­â€¦";
      sub.textContent = "";

      const url = `${scriptUrl}?id=${encodeURIComponent(id)}&mode=${mode}&token=${token}&device=${device}`;
      // debug.style.display="block"; debug.textContent = url;

      try{
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();

        if(!data.ok){
          throw new Error(data.message || "unknown");
        }

        // æˆåŠŸï¼ˆINãªã®ã§é‡‘é¡ãªã©ã¯å‡ºã•ãªã„ï¼‰
        msg.innerHTML = `<span style="font-size:36px;font-weight:1000">${id} ã•ã‚“</span>`;
        sub.innerHTML = `<div style="font-size:20px;font-weight:900;color:#444">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€€å…¥å®¤OK</div>`;

        beep("ok");
        lockUntil = Date.now() + OK_LOCK_MS;

      }catch(e){
        msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
        sub.textContent = (e?.message || e);
        beep("ng");
        lockUntil = Date.now() + FAIL_LOCK_MS;

      }finally{
        // ãƒ­ãƒƒã‚¯è§£é™¤å¾Œã«ã‚¹ã‚­ãƒ£ãƒ³å†é–‹
        setTimeout(()=>{ sending = false; }, 400);
      }
    }

    /********************
     * ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ—
     ********************/
    function loop(){
      const now = Date.now();

      // è¡¨ç¤ºãƒ­ãƒƒã‚¯ä¸­ã¯èª­ã‚€ã ã‘æ­¢ã‚ã‚‹ï¼ˆç”»é¢ã¯ç¶­æŒï¼‰
      if(now < lockUntil){
        requestAnimationFrame(loop);
        return;
      }

      // é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
      if(msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„" && !sending){
        msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
        sub.textContent = "";
      }

      const raw = readQR();
      if(raw){
        const id = extractId(raw);
        if(id){
          send(id);
        }
      }

      setTimeout(()=>requestAnimationFrame(loop), SCAN_INTERVAL_MS);
    }

    /********************
     * èµ·å‹•
     ********************/
    (async ()=>{
      try{
        await startCamera();
        requestAnimationFrame(loop);
      }catch(e){
        msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼ˆè¨±å¯ã‚’ç¢ºèªï¼‰";
        sub.textContent = (e?.message || e);
        // debug.style.display="block"; debug.textContent = "CAMERA ERROR: " + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
