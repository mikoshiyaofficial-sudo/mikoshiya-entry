<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ - ç¥­ã‚Šå‚åŠ </title>

  <!-- QR decode -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --red:#d44747;
      --fg:#222;
      --bg:#f3f3f3;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--fg);
      text-align:center;
    }
    h1{
      margin: 28px 0 0;
      font-size: 34px;
      font-weight: 800;
      letter-spacing: .02em;
    }
    h2{
      margin: 10px 0 18px;
      font-size: 26px;           /* â†ã€Œç¥­ã‚Šå‚åŠ ã€å°ã•ã„å•é¡Œã¯ã“ã“ */
      font-weight: 800;
      color: var(--red);
    }

    /* ã‚«ãƒ¡ãƒ©æ ï¼ˆã“ã“ã§â€œã§ã‹ããªã‚‹â€ã®ã‚’é˜²ãï¼‰ */
    .frame{
      width: min(92vw, 980px);
      aspect-ratio: 4 / 3;
      margin: 14px auto 14px;
      border: 6px solid var(--red);
      border-radius: 14px;
      overflow: hidden;
      background:#111;
      box-sizing:border-box;
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    #msg{
      margin: 12px auto 0;
      font-size: 26px;
      font-weight: 700;
      min-height: 44px;
      width: min(92vw, 980px);
    }

    #enableSound{
      margin: 14px auto 0;
      padding: 14px 18px;
      font-size: 20px;
      font-weight: 800;
      border: 0;
      border-radius: 12px;
      background:#111;
      color:#fff;
      cursor:pointer;
      width: min(60vw, 420px);
    }
    #enableSound[disabled]{
      opacity:.55;
      cursor: default;
    }

    #debug{
      margin: 12px auto 18px;
      width: min(92vw, 980px);
      font-size: 14px;
      color:#666;
      word-break: break-all;
      min-height: 18px;
    }

    /* æˆåŠŸè¡¨ç¤ºã®è¦‹ãŸç›® */
    .ok-name{
      font-size: 30px;
      font-weight: 900;
      margin-top: 4px;
    }
    .ok-thanks{
      font-size: 18px;
      margin-top: 6px;
      color:#666;
      font-weight: 700;
    }
    .ok-time{
      font-size: 24px;
      margin-top: 10px;
      font-weight: 900;
    }
    .ok-amount{
      font-size: 44px;
      margin-top: 10px;
      font-weight: 1000;
      color: var(--red);
      letter-spacing: .02em;
    }

    /* iPadã§ä½™ç™½ãŒå¤‰ã«ãªã‚Šã«ãã„ */
    .safe-bottom{ height: env(safe-area-inset-bottom); }
  </style>
</head>

<body>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
  <h2>ç¥­ã‚Šå‚åŠ </h2>

  <div class="frame">
    <video id="video" playsinline muted></video>
  </div>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div id="debug"></div>
  <div class="safe-bottom"></div>

  <script>
    /* ========= è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰ ========= */
    const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec";
    const token     = "MIKOSHIYA_2026";
    const device    = "mikoshiya-ipad-entry";  // â†å…¥å®¤å´
    const mode      = "IN";                    // â†ç¥­ã‚Šå‚åŠ  = IN
    /* ======================================== */

    /* ========= å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ========= */
    const OK_LOCK_MS      = 3500;  // æˆåŠŸè¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“ â†’ è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸°
    const FAIL_LOCK_MS    = 1200;
    const SCAN_INTERVAL_MS= 120;   // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”ï¼ˆè² è·èª¿æ•´ï¼‰
    const DUP_GUARD_MS    = 2500;  // åŒã˜QRé€£æ‰“é˜²æ­¢
    /* ================================= */

    /* ========= DOM ========= */
    const video = document.getElementById("video");
    const msg   = document.getElementById("msg");
    const debug = document.getElementById("debug");
    const btnSound = document.getElementById("enableSound");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    /* ========= çŠ¶æ…‹ ========= */
    let sending = false;
    let lockUntil = 0;
    let lastId = "";
    let lastIdAt = 0;

    /* ========= éŸ³ ========= */
    const soundOk  = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="); // ãƒ€ãƒŸãƒ¼
    const soundOut = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="); // ãƒ€ãƒŸãƒ¼
    // â†‘ ã‚‚ã—å®ŸéŸ³æºURLãŒã‚ã‚‹ãªã‚‰ã€ã“ã“ã‚’ mp3/wav ã®URLã«å·®ã—æ›¿ãˆã¦OK

    let audioUnlocked = false;
    btnSound.addEventListener("click", async () => {
      try{
        // iOSå¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ä¸€åº¦playã—ã¦ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        soundOk.volume = 1.0;
        soundOut.volume = 1.0;
        await soundOk.play();
        soundOk.pause();
        soundOk.currentTime = 0;
        audioUnlocked = true;
        btnSound.textContent = "âœ… éŸ³ æœ‰åŠ¹";
        btnSound.disabled = true;
        debug.textContent = "audio unlocked";
      }catch(e){
        debug.textContent = "audio unlock failed: " + (e?.message || e);
      }
    });

    /* ========= ã‚«ãƒ¡ãƒ©é–‹å§‹ ========= */
    async function startCamera(){
      const constraints = {
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        audio: false
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
    }

    /* ========= QRèª­ã¿å–ã‚Š ========= */
    function readQR(){
      if (video.readyState < 2) return null;
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h) return null;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      const imageData = ctx.getImageData(0, 0, w, h);
      const code = jsQR(imageData.data, w, h, { inversionAttempts: "attemptBoth" });
      return code ? (code.data || "") : null;
    }

    function extractId(qrText){
      // QRãŒã€ŒA-00000ã€å˜ä½“ã§ã‚‚ã€URLã§ã‚‚ã€?id= ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
      const t = String(qrText || "").trim();
      if (!t) return "";

      // ãã®ã¾ã¾IDã£ã½ã„
      if (/^[A-Za-z0-9_-]{3,}$/.test(t) && !t.includes("http")) return t;

      // URL / ã‚¯ã‚¨ãƒª
      try{
        const u = new URL(t);
        const id = (u.searchParams.get("id") || u.searchParams.get("ID") || "").trim();
        if (id) return id;
      }catch(_){}

      // æœ€å¾Œã«ã€Œid=ã€ã ã‘é›‘ã«æ‹¾ã†
      const m = t.match(/[?&]id=([^&]+)/i);
      if (m && m[1]) return decodeURIComponent(m[1]).trim();

      return "";
    }

    /* ========= é€ä¿¡ ========= */
    async function send(id){
      const now = Date.now();
      if (sending) return;
      if (now < lockUntil) return;

      // 2é‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ï¼ˆåŒã˜IDã‚’çŸ­æ™‚é–“ã§å¼¾ãï¼‰
      if (id && id === lastId && (now - lastIdAt) < DUP_GUARD_MS){
        return;
      }
      lastId = id;
      lastIdAt = now;

      sending = true;

      const url =
        `${scriptUrl}?id=${encodeURIComponent(id)}&mode=${encodeURIComponent(mode)}&token=${encodeURIComponent(token)}&device=${encodeURIComponent(device)}`;

      debug.textContent = url; // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé‚ªé­”ãªã‚‰æ¶ˆã—ã¦OKï¼‰

      try{
        const res = await fetch(url, { cache:"no-store" });
        const text = await res.text(); // JSONã§ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚æ‹¾ã†

        if (!res.ok){
          throw new Error(`HTTP ${res.status}: ${text}`);
        }

        let data = null;
        try{ data = JSON.parse(text); }catch(_){}

        if (data && data.ok === true){
          // âœ… æˆåŠŸè¡¨ç¤ºï¼ˆINã¯é‡‘é¡ãƒ»æ™‚é–“ã‚’å‡ºã•ãªã„ä»•æ§˜ã«ã™ã‚‹ã®ãŒå®‰å®šï¼‰
          // ã‚‚ã—INã§ã‚‚è¡¨ç¤ºã—ãŸã‘ã‚Œã°ã€GASå´ãŒè¿”ã—ãŸå€¤ã«åˆã‚ã›ã¦ã“ã“ã«è¶³ã™
          msg.innerHTML =
            `<div class="ok-name">${id} ã•ã‚“</div>` +
            `<div class="ok-thanks">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</div>` +
            `<div class="ok-time">å…¥å®¤ OK</div>`;

          lockUntil = Date.now() + OK_LOCK_MS;

          if (audioUnlocked){
            soundOk.currentTime = 0;
            soundOk.play();
          }

        }else{
          const reason = (data && data.message) ? data.message : text;
          throw new Error(reason || "unknown");
        }

      }catch(e){
        msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
        debug.textContent = `ERROR: ${String(e && e.message ? e.message : e)}`;
        lockUntil = Date.now() + FAIL_LOCK_MS;
      }finally{
        setTimeout(() => {
          sending = false;
          requestAnimationFrame(scan);
        }, 800);
      }
    }

    /* ========= ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ— ========= */
    function scan(){
      const now = Date.now();
      if (now < lockUntil){
        requestAnimationFrame(scan);
        return;
      }

      // è¡¨ç¤ºã‚’ãƒˆãƒƒãƒ—ã«æˆ»ã™
      if (msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„" && msg.innerHTML !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„"){
        msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
      }

      const qr = readQR();
      if (qr){
        const id = extractId(qr);
        if (id){
          send(id);
          return;
        }
      }

      setTimeout(() => requestAnimationFrame(scan), SCAN_INTERVAL_MS);
    }

    /* ========= èµ·å‹• ========= */
    (async () => {
      try{
        await startCamera();
        requestAnimationFrame(scan);
      }catch(e){
        msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆSafariã®è¨±å¯ã‚’ç¢ºèªï¼‰";
        debug.textContent = `CAMERA ERROR: ${String(e && e.message ? e.message : e)}`;
      }
    })();
  </script>
</body>
</html>
