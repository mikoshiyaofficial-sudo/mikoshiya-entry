<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v3</title>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --red:#d44747;
      --text:#111;
      --muted:#666;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
      text-align:center;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:20px 12px 8px; }
    h1{ margin:0; font-size:40px; font-weight:900; letter-spacing:.02em; }
    h2{ margin:10px 0 0; font-size:34px; font-weight:1000; color:var(--red); }

    .frame{
      width:min(92vw, 980px);
      aspect-ratio: 4 / 3;
      margin:14px auto 10px;
      border:6px solid var(--red);
      border-radius:16px;
      overflow:hidden;
      background:#111;
      box-sizing:border-box;
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    #msg{
      width:min(92vw, 980px);
      margin:10px auto 0;
      min-height:56px;
      font-size:30px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #sub{
      width:min(92vw, 980px);
      margin:4px auto 0;
      min-height:28px;
      font-size:18px;
      font-weight:800;
      color:var(--muted);
    }

    #enableSound{
      margin:14px auto 8px;
      padding:16px 18px;
      font-size:22px;
      font-weight:900;
      border:0;
      border-radius:14px;
      background:#111;
      color:#fff;
      width:min(70vw, 520px);
    }
    #enableSound[disabled]{ opacity:.55; }

    #ver{
      position:fixed;
      right:10px;
      top:10px;
      font-size:12px;
      color:#888;
      font-weight:800;
    }

    /* ã“ã“ã‚’ block ã«ã™ã‚‹ã¨ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º */
    #debug{
      display:none;
      width:min(92vw, 980px);
      margin:8px auto 16px;
      font-size:12px;
      color:#666;
      word-break:break-all;
      text-align:left;
    }
  </style>
</head>

<body>
  <div id="ver">v3</div>

  <header>
    <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
    <h2>è‡ªå‹• å…¥é€€å®¤</h2>
  </header>

  <div class="frame">
    <video id="video" playsinline muted></video>
  </div>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <div id="sub"></div>

  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div id="debug"></div>

  <script>
    /********************
     * è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰
     ********************/
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzpIuZ3HQus23p5Fz4QiQDqCUweTcYFWT4loaF9lFPzdP2qpBu0Cfvb58jkN-MD3bZkrA/exec";  // ä¾‹: https://script.google.com/macros/s/XXXX/exec
    const token  = "MIKOSHIYA_2026";
    const device = "mikoshiya-ipad-v3";

    /********************
     * å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     ********************/
    const OK_LOCK_MS       = 4500;    // æˆåŠŸè¡¨ç¤ºã—ã¦ã‚‹æ™‚é–“ï¼ˆå…¥å®¤/é€€å®¤ï¼‰
    const FAIL_LOCK_MS     = 1600;    // å¤±æ•—è¡¨ç¤º
    const SCAN_INTERVAL_MS = 120;     // ã‚¹ã‚­ãƒ£ãƒ³é–“éš”
    const DUP_GUARD_MS     = 20000;   // 20ç§’ åŒã˜QRé€£æ‰“é˜²æ­¢ï¼ˆå®Œå…¨ç‰ˆï¼‰
    const QR_CROP          = 1.0;     // 0.65ã€œ1.0ï¼ˆé‡ã„/èª­ã¾ãªã„æ™‚ã ã‘0.8ã¨ã‹ã«ï¼‰

    /********************
     * DOM
     ********************/
    const video = document.getElementById("video");
    const msg   = document.getElementById("msg");
    const sub   = document.getElementById("sub");
    const btnSound = document.getElementById("enableSound");
    const debug = document.getElementById("debug");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently:true });

    /********************
     * çŠ¶æ…‹
     ********************/
    let sending = false;
    let lockUntil = 0;
    let lastId = "";
    let lastIdAt = 0;

    /********************
     * éŸ³ï¼ˆiPadã§ã‚‚ç¢ºå®Ÿãª AudioContextï¼‰
     ********************/
    let audioCtx = null;
    let soundEnabled = false;

    function beep(type="ok"){
      if(!soundEnabled || !audioCtx) return;

      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      // ok: é«˜ã‚ / ng: ä½ã‚
      osc.frequency.value = (type==="ok") ? 880 : 220;
      osc.type = "sine";

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.17);
    }

    btnSound.addEventListener("click", async ()=>{
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        await audioCtx.resume();
        soundEnabled = true;
        btnSound.textContent = "âœ… éŸ³ æœ‰åŠ¹";
        btnSound.disabled = true;
        beep("ok");
      }catch(e){
        debug.style.display="block";
        debug.textContent = "AUDIO ERROR: " + (e?.message || e);
      }
    });

    /********************
     * ã‚«ãƒ¡ãƒ©èµ·å‹•
     ********************/
    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width:  { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio:false
      });
      video.srcObject = stream;
      await video.play();
    }

    /********************
     * QR èª­ã¿å–ã‚Š
     ********************/
    function readQR(){
      if(video.readyState < 2) return null;

      const w0 = video.videoWidth, h0 = video.videoHeight;
      if(!w0 || !h0) return null;

      // ä¸­å¤®åˆ‡ã‚ŠæŠœãï¼ˆé‡ã•/èª­ã¿ã‚„ã™ã•èª¿æ•´ï¼‰
      const crop = Math.max(0.4, Math.min(1.0, QR_CROP));
      const cw = Math.floor(w0 * crop);
      const ch = Math.floor(h0 * crop);
      const sx = Math.floor((w0 - cw) / 2);
      const sy = Math.floor((h0 - ch) / 2);

      canvas.width = cw;
      canvas.height = ch;
      ctx.drawImage(video, sx, sy, cw, ch, 0, 0, cw, ch);

      const img = ctx.getImageData(0,0,cw,ch);
      const code = jsQR(img.data, cw, ch, { inversionAttempts:"attemptBoth" });
      return code ? (code.data || "") : null;
    }

    function extractId(text){
      text = String(text||"").trim();
      if(!text) return "";

      // 1) IDã ã‘ã®QR
      if (/^[A-Za-z0-9_-]{3,}$/.test(text) && !text.includes("http")) return text;

      // 2) URLå‹ (?id=)
      try{
        const u = new URL(text);
        const id = (u.searchParams.get("id") || u.searchParams.get("ID") || "").trim();
        if(id) return id;
      }catch(_){}

      // 3) å¿µã®ãŸã‚ regex
      const m = text.match(/[?&]id=([^&]+)/i);
      return m ? decodeURIComponent(m[1]).trim() : "";
    }

    function setScreenDefault(){
      msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
      sub.textContent = "";
    }

    function showError(main, detail){
      msg.textContent = main;
      sub.textContent = detail || "";
      beep("ng");
      lockUntil = Date.now() + FAIL_LOCK_MS;
    }

    function showInOk(id){
      msg.innerHTML = `<span style="font-size:38px;font-weight:1000">${esc(id)} ã•ã‚“</span>`;
      sub.innerHTML = `<div style="font-size:20px;font-weight:900;color:#444">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€€å…¥å®¤OK</div>`;
      beep("ok");
      lockUntil = Date.now() + OK_LOCK_MS;
    }

    function showOutOk(id, minutes, amount){
      msg.innerHTML =
        `<div style="font-size:34px;font-weight:1000">${esc(id)} ã•ã‚“</div>`;
      sub.innerHTML =
        `<div style="font-size:22px;font-weight:900;color:#444;margin-top:4px">åˆ©ç”¨æ™‚é–“ï¼š${minutes} åˆ†</div>` +
        `<div style="font-size:44px;font-weight:1000;color:#d44747;margin-top:6px">æ–™é‡‘ï¼š${amount} å††</div>`;
      beep("ok");
      lockUntil = Date.now() + OK_LOCK_MS;
    }

    /********************
     * é€ä¿¡ï¼ˆv3ï¼šmodeç„¡ã—ï¼‰
     ********************/
    async function send(id){
      const now = Date.now();
      if(sending || now < lockUntil) return;

      // 20ç§’ åŒä¸€IDã‚¬ãƒ¼ãƒ‰
      if(id === lastId && (now - lastIdAt) < DUP_GUARD_MS) return;

      lastId = id;
      lastIdAt = now;

      sending = true;
      msg.textContent = "é€šä¿¡ä¸­â€¦";
      sub.textContent = "";

      try{
        const url = `${scriptUrl}?id=${encodeURIComponent(id)}&token=${encodeURIComponent(token)}&device=${encodeURIComponent(device)}&t=${Date.now()}`;
        // debug.style.display="block"; debug.textContent = url;

        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        if(!data || data.ok !== true) throw new Error(data?.message || "unknown");

        // GAS v3: action ãŒ IN/OUT
        if(data.action === "IN"){
          showInOk(id);
        }else if(data.action === "OUT"){
          showOutOk(id, Number(data.minutes ?? 0), Number(data.amount ?? 0));
        }else{
          // äºˆæœŸã—ãªã„å ´åˆã§ã‚‚è¡¨ç¤º
          showError("é€šä¿¡çµæœãŒä¸æ˜", JSON.stringify(data));
        }

      }catch(e){
        showError("é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­", (e?.message || e));
      }finally{
        setTimeout(()=>{ sending = false; }, 350);
      }
    }

    /********************
     * ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ—
     ********************/
    function loop(){
      const now = Date.now();

      // ãƒ­ãƒƒã‚¯ä¸­ã¯è¡¨ç¤ºç¶­æŒï¼ˆã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ï¼‰
      if(now < lockUntil){
        requestAnimationFrame(loop);
        return;
      }

      // é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
      if(!sending && msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„"){
        setScreenDefault();
      }

      const raw = readQR();
      if(raw){
        const id = extractId(raw);
        if(id){
          send(id);
        }
      }

      setTimeout(()=>requestAnimationFrame(loop), SCAN_INTERVAL_MS);
    }

    function esc(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /********************
     * èµ·å‹•
     ********************/
    (async ()=>{
      try{
        if(typeof jsQR !== "function"){
          msg.textContent = "QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
          return;
        }
        await startCamera();
        requestAnimationFrame(loop);
      }catch(e){
        msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼ˆè¨±å¯ã‚’ç¢ºèªï¼‰";
        sub.textContent = (e?.message || e);
      }
    })();
  </script>
</body>
</html>
