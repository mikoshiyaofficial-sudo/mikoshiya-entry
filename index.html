/*************** 共通設定 ***************/

const scriptUrl = "あなたのGAS URL";
const token = "MIKOSHIYA_2026";

// 入室画面 → IN
// 退室画面 → OUT
const mode = "OUT"; // ← entryはIN / exitはOUT

const device = "mikoshiya-ipad";

/*************** 動作パラメータ ***************/
const OK_LOCK_MS = 3500;     // 成功画面表示
const FAIL_LOCK_MS = 1500;   // エラー表示
const SCAN_INTERVAL_MS = 120;
const DUP_GUARD_MS = 20000;  // 20秒連続防止

/*************** DOM ***************/
const video = document.getElementById("video");
const msg = document.getElementById("msg");
const btnSound = document.getElementById("enableSound");

/*************** 状態 ***************/
let sending = false;
let lockUntil = 0;
let lastId = "";
let lastScanTime = 0;
let soundEnabled = false;

/*************** 音 ***************/
const okSound = new Audio("taiko.mp3");
const failSound = new Audio("error.mp3");

btnSound.onclick = async () => {
  await okSound.play().catch(()=>{});
  soundEnabled = true;
  btnSound.style.display = "none";
};

/*************** カメラ ***************/
async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;
  video.play();
}

/*************** QR送信 ***************/
async function sendQR(id) {
  if (sending) return;

  const now = Date.now();

  // 20秒ガード
  if (id === lastId && now - lastScanTime < DUP_GUARD_MS) {
    return;
  }

  sending = true;
  lastId = id;
  lastScanTime = now;

  msg.innerText = "通信中...";

  try {
    const res = await fetch(
      `${scriptUrl}?id=${id}&mode=${mode}&token=${token}&device=${device}`
    );
    const data = await res.json();

    if (data.ok) {
      if (soundEnabled) okSound.play();

      msg.innerText =
        `${id} さん\n` +
        `利用時間：${data.minutes || 0}分\n` +
        `料金：${data.amount || 0}円`;

      lockUntil = now + OK_LOCK_MS;

    } else {
      if (soundEnabled) failSound.play();
      msg.innerText = data.message;
      lockUntil = now + FAIL_LOCK_MS;
    }

  } catch (e) {
    msg.innerText = "通信失敗";
    lockUntil = now + FAIL_LOCK_MS;
  }

  sending = false;
}

/*************** 自動トップ復帰 ***************/
setInterval(() => {
  if (Date.now() > lockUntil) {
    msg.innerText = "QRをかざしてください";
  }
}, 300);

/*************** 起動 ***************/
startCamera();
