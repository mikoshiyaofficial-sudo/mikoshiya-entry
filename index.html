<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v3 - è‡ªå‹•å…¥é€€å®¤</title>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --red:#d44747;
      --text:#111;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
      text-align:center;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:22px 12px 8px; }
    h1{ margin:0; font-size:40px; font-weight:900; }
    h2{ margin:10px 0 0; font-size:32px; font-weight:900; color:var(--red); }

    .frame{
      width:min(92vw, 980px);
      aspect-ratio:4/3;
      margin:14px auto 10px;
      border:6px solid var(--red);
      border-radius:16px;
      overflow:hidden;
      background:#111;
    }
    video{ width:100%; height:100%; object-fit:cover; }

    #msg{
      margin-top:10px;
      font-size:32px;
      font-weight:900;
      min-height:48px;
    }
    #sub{
      font-size:20px;
      font-weight:800;
      color:#555;
      min-height:26px;
    }

    #enableSound{
      margin:16px auto;
      padding:14px 20px;
      font-size:22px;
      font-weight:900;
      border-radius:14px;
      border:0;
      background:#111;
      color:#fff;
      width:min(70vw, 520px);
    }

    #ver{
      position:fixed;
      right:10px;
      top:10px;
      font-size:12px;
      color:#888;
      font-weight:800;
    }

    /* ===== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ===== */
    .flash{
      position:fixed;
      inset:0;
      background:white;
      pointer-events:none;
      animation:flashAnim .4s ease-out forwards;
      z-index:9999;
    }
    @keyframes flashAnim{
      from{opacity:1;}
      to{opacity:0;}
    }

    .firework{
      position:fixed;
      width:20px;
      height:20px;
      border-radius:50%;
      animation:explode .8s ease-out forwards;
      pointer-events:none;
      z-index:9999;
    }
    @keyframes explode{
      from{transform:scale(.3);opacity:1;}
      to{transform:scale(8);opacity:0;}
    }
  </style>
</head>

<body>
<div id="ver">v3</div>

<header>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
  <h2>è‡ªå‹• å…¥é€€å®¤</h2>
</header>

<div class="frame">
  <video id="video" playsinline muted></video>
</div>

<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
<div id="sub"></div>

<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/******** è¨­å®š ********/
const scriptUrl = "https://script.google.com/macros/s/AKfycbw9WwZ0qXAICy8VIjimrS-ySv6cp4q7HztZqIZDtgRUEfROhhJEWpzZBvxhdOg808jE/exec";
const token  = "MIKOSHIYA_2026";
const device = "mikoshiya-ipad-v3";

/******** çŠ¶æ…‹ ********/
let sending=false, lockUntil=0;
let lastId="", lastAt=0;

/******** DOM ********/
const video=document.getElementById("video");
const msg=document.getElementById("msg");
const sub=document.getElementById("sub");
const btnSound=document.getElementById("enableSound");

/******** Audio ********/
let audioCtx=null, soundOn=false;
function playSound(type){
  if(!soundOn||!audioCtx)return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="sine";
  o.frequency.value = type==="IN"?880:220;
  g.gain.setValueAtTime(.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.3,audioCtx.currentTime+.02);
  g.gain.exponentialRampToValueAtTime(.0001,audioCtx.currentTime+.2);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+.21);
}

btnSound.onclick=async()=>{
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  await audioCtx.resume();
  soundOn=true;
  btnSound.textContent="âœ… éŸ³ æœ‰åŠ¹";
  btnSound.disabled=true;
  playSound("IN");
};

/******** ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ********/
function flash(color){
  const f=document.createElement("div");
  f.className="flash";
  f.style.background=color;
  document.body.appendChild(f);
  setTimeout(()=>f.remove(),400);
}
function firework(){
  const e=document.createElement("div");
  e.className="firework";
  e.style.left=(40+Math.random()*20)+"%";
  e.style.top =(40+Math.random()*20)+"%";
  e.style.background=`hsl(${Math.random()*360},100%,50%)`;
  document.body.appendChild(e);
  setTimeout(()=>e.remove(),800);
}

/******** Camera ********/
async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},
    audio:false
  });
  video.srcObject=stream;
  await video.play();
}

/******** QR ********/
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});

function readQR(){
  if(video.readyState<2)return null;
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code=jsQR(img.data,canvas.width,canvas.height);
  return code?code.data:null;
}

/******** Send ********/
async function send(id){
  if(sending||Date.now()<lockUntil)return;
  if(id===lastId && Date.now()-lastAt<20000)return;
  lastId=id; lastAt=Date.now();
  sending=true;
  msg.textContent="é€šä¿¡ä¸­â€¦"; sub.textContent="";

  try{
    const url=`${scriptUrl}?id=${encodeURIComponent(id)}&token=${token}&device=${device}`;
    const res=await fetch(url,{cache:"no-store"});
    const data=await res.json();
    if(!data.ok) throw new Error(data.message);

    if(data.action==="IN"){
      msg.textContent=`${id} ã•ã‚“`;
      sub.textContent="ç¥­ã‚Šã«å‚åŠ  ğŸ‰";
      flash("white"); firework(); playSound("IN");
    }else{
      msg.textContent=`${id} ã•ã‚“`;
      sub.textContent=`é€€å®¤ OKã€€${data.minutes}åˆ† / ${data.amount}å††`;
      flash("rgba(255,0,0,.4)"); playSound("OUT");
    }
    lockUntil=Date.now()+3500;
  }catch(e){
    msg.textContent="é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
    sub.textContent=e.message||e;
    playSound("OUT");
    lockUntil=Date.now()+1500;
  }finally{
    setTimeout(()=>sending=false,400);
  }
}

/******** Loop ********/
function loop(){
  if(Date.now()<lockUntil){ requestAnimationFrame(loop); return; }
  msg.textContent="QRã‚’ã‹ã–ã—ã¦ãã ã•ã„"; sub.textContent="";
  const raw=readQR();
  if(raw) send(raw.trim());
  setTimeout(()=>requestAnimationFrame(loop),120);
}

/******** Start ********/
(async()=>{
  await startCamera();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
