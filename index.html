<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ - ç¥­ã‚Šå‚åŠ </title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;text-align:center;background:#f3f3f3}
    h1{margin:28px 0 0;font-size:34px;font-weight:800}
    h2{margin:10px 0 18px;font-size:32px;font-weight:900;color:#d44747}
    .frame{width:min(92vw,980px);aspect-ratio:4/3;margin:14px auto;border:6px solid #d44747;border-radius:14px;overflow:hidden;background:#111;box-sizing:border-box}
    video{width:100%;height:100%;object-fit:cover;display:block}
    #msg{margin:12px auto 0;font-size:26px;font-weight:800;min-height:44px;width:min(92vw,980px)}
    #enableSound{margin:14px auto 0;padding:14px 18px;font-size:20px;font-weight:800;border:0;border-radius:12px;background:#111;color:#fff;width:min(60vw,420px)}
    #enableSound[disabled]{opacity:.55}
    #debug{margin:12px auto 18px;width:min(92vw,980px);font-size:14px;color:#666;word-break:break-all;min-height:18px}
  </style>
</head>
<body>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
  <h2>ç¥­ã‚Šå‚åŠ </h2>

  <div class="frame"><video id="video" playsinline muted></video></div>
  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div id="debug"></div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec";
    const token  = "MIKOSHIYA_2026";
    const device = "mikoshiya-ipad-entry";
    const mode   = "IN";

    const OK_LOCK_MS = 3500, FAIL_LOCK_MS = 1200, SCAN_INTERVAL_MS = 120, DUP_GUARD_MS = 2500;

    const video = document.getElementById("video");
    const msg   = document.getElementById("msg");
    const debug = document.getElementById("debug");
    const btnSound = document.getElementById("enableSound");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    let sending=false, lockUntil=0, lastId="", lastIdAt=0;
    let audioUnlocked=false;

    const okSound = new Audio();
    btnSound.addEventListener("click", async () => {
      try{
        await okSound.play().catch(()=>{}); // iOS unlockç”¨ï¼ˆç„¡éŸ³ã§ã‚‚OKï¼‰
        audioUnlocked = true;
        btnSound.textContent = "âœ… éŸ³ æœ‰åŠ¹";
        btnSound.disabled = true;
      }catch(e){
        debug.textContent = "audio unlock failed: " + (e?.message || e);
      }
    });

    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"environment", width:{ideal:1280}, height:{ideal:720} },
        audio:false
      });
      video.srcObject = stream;
      await video.play();
    }

    function readQR(){
      if (video.readyState < 2) return null;
      const w = video.videoWidth, h = video.videoHeight;
      if(!w||!h) return null;
      canvas.width=w; canvas.height=h;
      ctx.drawImage(video,0,0,w,h);
      const img = ctx.getImageData(0,0,w,h);
      const code = jsQR(img.data,w,h,{inversionAttempts:"attemptBoth"});
      return code ? (code.data||"") : null;
    }

    function extractId(t){
      t = String(t||"").trim();
      if(!t) return "";
      if (/^[A-Za-z0-9_-]{3,}$/.test(t) && !t.includes("http")) return t;
      try{
        const u = new URL(t);
        const id = (u.searchParams.get("id")||u.searchParams.get("ID")||"").trim();
        if(id) return id;
      }catch(_){}
      const m = t.match(/[?&]id=([^&]+)/i);
      return m ? decodeURIComponent(m[1]).trim() : "";
    }

    async function send(id){
      const now = Date.now();
      if (sending || now < lockUntil) return;
      if (id===lastId && (now-lastIdAt)<DUP_GUARD_MS) return;
      lastId=id; lastIdAt=now;
      sending=true;

      const url = `${scriptUrl}?id=${encodeURIComponent(id)}&mode=${mode}&token=${token}&device=${device}`;
      debug.textContent = url;

      try{
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();
        if(!data.ok) throw new Error(data.message || "unknown");

        msg.innerHTML = `<div style="font-size:30px;font-weight:900">${id} ã•ã‚“</div>
                         <div style="margin-top:6px;color:#666;font-weight:700">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</div>
                         <div style="margin-top:10px;font-size:24px;font-weight:900">å…¥å®¤ OK</div>`;
        lockUntil = Date.now() + OK_LOCK_MS;

      }catch(e){
        msg.textContent = "é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
        debug.textContent = "ERROR: " + (e?.message || e);
        lockUntil = Date.now() + FAIL_LOCK_MS;
      }finally{
        setTimeout(()=>{ sending=false; requestAnimationFrame(scan); }, 800);
      }
    }

    function scan(){
      const now = Date.now();
      if (now < lockUntil){ requestAnimationFrame(scan); return; }
      if (msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„") msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
      const qr = readQR();
      if(qr){
        const id = extractId(qr);
        if(id){ send(id); return; }
      }
      setTimeout(()=>requestAnimationFrame(scan), SCAN_INTERVAL_MS);
    }

    (async()=>{
      try{ await startCamera(); requestAnimationFrame(scan); }
      catch(e){
        msg.textContent="ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼ˆè¨±å¯ã‚’ç¢ºèªï¼‰";
        debug.textContent="CAMERA ERROR: " + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
