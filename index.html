<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v3 - è‡ªå‹•å…¥é€€å®¤</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
  text-align:center;
  background:#f4f4f4;
}
h1{margin:20px 0 0;font-size:38px;font-weight:900;}
h2{margin:8px 0 14px;font-size:26px;color:#d44747;font-weight:900;}

.frame{
  width:min(92vw,900px);
  aspect-ratio:4/3;
  margin:auto;
  border:6px solid #d44747;
  border-radius:16px;
  overflow:hidden;
  background:#000;
}
#video{
  width:100%;
  height:100%;
  object-fit:cover;
  pointer-events:none;
}

#msg{font-size:20px;font-weight:900;margin-top:12px;}
#sub{font-size:16px;margin-top:6px;color:#444;min-height:22px;}

#enableSound{
  margin:16px auto;
  padding:16px;
  font-size:20px;
  font-weight:900;
  border-radius:14px;
  border:0;
  background:#111;
  color:#fff;
}
#enableSound[disabled]{opacity:.5;}

.saleRow{margin-top:10px;}
.saleBtn{
  padding:12px 14px;
  margin:4px;
  font-weight:900;
  border-radius:10px;
  border:0;
  background:#fff;
}
</style>
</head>

<body>

<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
<h2>è‡ªå‹• å…¥é€€å®¤</h2>

<div class="frame">
  <video id="video" playsinline muted></video>
</div>

<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
<div id="sub"></div>

<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<div class="saleRow">
  <button class="saleBtn" onclick="sendSale(150,'drink')">ç‰©è²©ï¼šãƒ‰ãƒªãƒ³ã‚¯</button>
  <button class="saleBtn" onclick="sendSale(100,'snack')">ç‰©è²©ï¼šãŠè“å­</button>
</div>

<script>
/************ è¨­å®š ************/
const scriptUrl="https://script.google.com/macros/s/AKfycbyoH2eou4zXvI-O4nhIZ3p7dLRVqu8CXwiCvxyRv_At3GfafxFU-8J-KboSTmYJlG4QFg/exec";
const token="MIKOSHIYA_2026";
const device="mikoshiya-ipad-v3";

/************ çŠ¶æ…‹ ************/
let sending=false;
let lockUntil=0;
let lastId="";
let lastIdAt=0;
const DUP_GUARD=20000;

/************ éŸ³ ************/
const taiko=new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_2a2d7e0e86.mp3?filename=drum-hit-1-19943.mp3");
const hanabi=new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_2f5c0a6a66.mp3?filename=success-1-6297.mp3");
taiko.volume=0.9; hanabi.volume=0.9;

let soundEnabled=false;
document.getElementById("enableSound").onclick=async()=>{
  try{
    await taiko.play(); taiko.pause(); taiko.currentTime=0;
    await hanabi.play(); hanabi.pause(); hanabi.currentTime=0;
    soundEnabled=true;
    enableSound.disabled=true;
    enableSound.textContent="âœ… éŸ³ æœ‰åŠ¹";
  }catch(e){}
};

function playOK(){
  if(!soundEnabled)return;
  taiko.currentTime=0;
  taiko.play().catch(()=>{});
  setTimeout(()=>{
    hanabi.currentTime=0;
    hanabi.play().catch(()=>{});
  },180);
}
function playNG(){
  if(!soundEnabled)return;
  taiko.currentTime=0;
  taiko.play().catch(()=>{});
}

/************ ã‚«ãƒ¡ãƒ© ************/
const video=document.getElementById("video");
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"},audio:false
  });
  video.srcObject=stream;
  await video.play();
}

/************ QR ************/
function readQR(){
  if(video.readyState<2)return null;
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code=jsQR(img.data,canvas.width,canvas.height);
  return code?code.data:null;
}
function extractId(t){
  if(!t)return "";
  if(/^[A-Za-z0-9_-]{3,}$/.test(t)&&!t.includes("http"))return t;
  try{
    const u=new URL(t);
    return u.searchParams.get("id")||"";
  }catch(e){}
  return "";
}

/************ è‡ªå‹•é€ä¿¡ ************/
async function sendAuto(id){
  const now=Date.now();
  if(sending||now<lockUntil)return;
  if(id===lastId && now-lastIdAt<DUP_GUARD)return;
  lastId=id; lastIdAt=now;

  sending=true;
  msg.textContent="é€šä¿¡ä¸­â€¦";
  sub.textContent="";

  try{
    const res=await fetch(`${scriptUrl}?id=${id}&token=${token}&device=${device}&t=${Date.now()}`);
    const data=await res.json();

    if(!data.ok)throw new Error(data.message);

    if(data.action==="IN"){
      msg.innerHTML=`<b>${id} ã•ã‚“</b>`;
      sub.textContent="å…¥å®¤OK";
    }else{
      msg.innerHTML=`<b>${id} ã•ã‚“</b>`;
      sub.innerHTML=`é€€å®¤OK<br>åˆ©ç”¨æ™‚é–“ ${data.minutes}åˆ†<br><span style="color:#d44747;font-size:26px">${data.amount}å††</span>`;
    }

    playOK();
    lockUntil=Date.now()+3000;

  }catch(e){
    msg.textContent="é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
    sub.textContent=e.message||"";
    playNG();
    lockUntil=Date.now()+1500;
  }
  setTimeout(()=>sending=false,300);
}

/************ ç‰©è²© ************/
async function sendSale(amount,item){
  if(sending)return;
  sending=true;
  msg.textContent="é€šä¿¡ä¸­â€¦";
  try{
    await fetch(`${scriptUrl}?action=SALE&amount=${amount}&item=${item}&token=${token}&device=${device}&t=${Date.now()}`);
    msg.textContent="ç‰©è²©OK";
    sub.textContent=`${item} ${amount}å††`;
    playOK();
  }catch(e){
    msg.textContent="ç‰©è²©å¤±æ•—";
    playNG();
  }
  setTimeout(()=>sending=false,300);
}

/************ ãƒ«ãƒ¼ãƒ— ************/
function loop(){
  const raw=readQR();
  if(raw){
    const id=extractId(raw);
    if(id)sendAuto(id);
  }
  requestAnimationFrame(loop);
}

startCamera().then(loop).catch(e=>{
  msg.textContent="ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—";
});
</script>

</body>
</html>
