<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v2.5</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
  :root{
    --red:#d83a3a;
  }
  body{
    margin:0;
    text-align:center;
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
    background:#f7f7f7;
  }
  h1{
    margin:18px 0 6px;
    font-size:44px;
    letter-spacing:1px;
  }
  h2{
    margin:0 0 14px;
    color:var(--red);
    font-size:34px; /* â† ç¥­ã‚Šå‚åŠ ã‚’å¤§ãã */
    font-weight:800;
  }

  /* ã‚«ãƒ¡ãƒ©æ ï¼ˆã“ã“ã«åã‚ã‚‹ï¼‰ */
  .frame{
    width:min(820px, 92vw);
    height:min(980px, 62vh);   /* iPadã§ãƒ‡ã‚«ããªã‚Šã™ããªã„ */
    margin:0 auto;
    border:8px solid var(--red);
    border-radius:26px;
    background:#111;
    overflow:hidden;
    box-sizing:border-box;
  }
  video{
    width:100%;
    height:100%;
    object-fit:cover; /* æ ã„ã£ã±ã„ã«åã‚ã‚‹ */
    display:block;
  }

  #msg{
    margin:18px 0 6px;
    font-size:28px;
    font-weight:700;
    min-height:40px;
  }

  /* éŸ³ãƒœã‚¿ãƒ³ï¼šå¿…ãšè¦‹ãˆã‚‹ã‚ˆã†ã«å›ºå®š */
  #enableSound{
    display:inline-block;
    margin:10px auto 10px;
    padding:14px 18px;
    font-size:22px;
    font-weight:700;
    border-radius:14px;
    border:2px solid #ddd;
    background:#fff;
  }

  #debug{
    margin:6px 0 16px;
    font-size:14px;
    color:#777;
    min-height:18px;
  }

  .ok{
    color:var(--red);
    font-size:34px;
    font-weight:900;
    line-height:1.35;
  }
</style>
</head>

<body>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
  <h2>ç¥­ã‚Šå‚åŠ </h2>

  <div class="frame">
    <video id="video" playsinline muted></video>
  </div>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
  <div id="debug"></div>

<script>
/* ===== è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰ ===== */
const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec"; // â˜…å·®ã—æ›¿ãˆ
const token  = "MIKOSHIYA_2026";
const device = "mikoshiya-ipad-entry";
const mode   = "IN"; // ç¥­ã‚Šå‚åŠ  = IN
/* =============================== */

const OK_LOCK_MS = 2000;
const FAIL_LOCK_MS = 1200;
const SCAN_INTERVAL_MS = 120;
const DUP_GUARD_MS = 2500;

const video = document.getElementById("video");
const msg   = document.getElementById("msg");
const debug = document.getElementById("debug");
const btnSound = document.getElementById("enableSound");

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d",{willReadFrequently:true});

let sending=false;
let lockUntil=0;
let lastId="";
let lastIdAt=0;

let audioCtx=null;

btnSound.addEventListener("click", async ()=>{
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // iOSã§ç¢ºå®Ÿã«èµ·ã“ã™
    if (audioCtx.state === "suspended") await audioCtx.resume();
    beep(1100, 0.08);
    btnSound.textContent = "âœ… éŸ³ OK";
    setTimeout(()=>{ btnSound.style.display="none"; }, 600);
  }catch(e){
    debug.textContent = "éŸ³ã®åˆæœŸåŒ–å¤±æ•—: " + e;
  }
});

function beep(freq=880,duration=0.12){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value=freq;
  gain.gain.value=0.2;
  osc.start();
  setTimeout(()=>{
    try{ osc.stop(); }catch(_){}
  }, duration*1000);
}

/* ===== ã‚«ãƒ¡ãƒ© ===== */
(async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:"environment",
        width:{ideal:1280},
        height:{ideal:720}
      },
      audio:false
    });
    video.srcObject = stream;
    await video.play();
    requestAnimationFrame(scanLoop);
  }catch(e){
    msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼ˆè¨­å®šã§è¨±å¯ã—ã¦ã­ï¼‰";
    debug.textContent = String(e);
  }
})();

/* ===== ã‚¹ã‚­ãƒ£ãƒ³ ===== */
function scanLoop(){
  if(Date.now()<lockUntil){
    requestAnimationFrame(scanLoop);
    return;
  }

  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0);

    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data, canvas.width, canvas.height);

    if(code){
      const id = (code.data || "").trim();

      if(id===lastId && Date.now()-lastIdAt < DUP_GUARD_MS){
        requestAnimationFrame(scanLoop);
        return;
      }

      lastId = id;
      lastIdAt = Date.now();
      send(id);
    }
  }

  setTimeout(()=>requestAnimationFrame(scanLoop), SCAN_INTERVAL_MS);
}

/* ===== é€ä¿¡ ===== */
async function send(id){
  if(sending) return;
  sending = true;

  msg.textContent = "é€ä¿¡ä¸­...";

  try{
    const url = `${scriptUrl}?id=${encodeURIComponent(id)}&mode=${mode}&token=${encodeURIComponent(token)}&device=${encodeURIComponent(device)}`;
    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text();

    let data=null;
    try{ data = JSON.parse(text); }catch(_){}

    if(data && data.ok === true){
      beep(1300,0.09);
      msg.innerHTML = `<div class="ok">${id} ã•ã‚“<br>å…¥å®¤ã—ã¾ã—ãŸ</div>`;
      lockUntil = Date.now() + OK_LOCK_MS;
    }else{
      beep(300,0.2);
      msg.textContent = (data && data.message) ? data.message : "é€šä¿¡å¤±æ•—";
      debug.textContent = (data && data.message) ? "" : text;
      lockUntil = Date.now() + FAIL_LOCK_MS;
    }

  }catch(e){
    msg.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    debug.textContent = String(e);
    lockUntil = Date.now() + FAIL_LOCK_MS;
  }

  sending = false;
}

/* ===== è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸° ===== */
setInterval(()=>{
  if(Date.now() > lockUntil && !sending){
    if(msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„") msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
  }
}, 400);

</script>
</body>
</html>
