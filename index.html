<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v2.5</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr"></script>

<style>
body{
  text-align:center;
  font-family:sans-serif;
}

h1{
  font-size:48px;
}

h2{
  color:red;
  font-size:36px;
}

#msg{
  font-size:28px;
  margin-top:20px;
}

.ok{
  color:red;
  font-size:40px;
}

video{
  width:80%;
  border:8px solid red;
  border-radius:20px;
}
</style>

</head>

<body>

<h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
<h2>ç¥­ã‚Šå‚åŠ </h2>

<video id="video" playsinline muted></video>

<div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
<button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
<div id="debug"></div>

<script>

/* ========= è¨­å®š ========= */

const scriptUrl = "https://script.google.com/macros/s/AKfycbygciufvsabhNk04OosYA2nf4VzcPCPCqX4_yAD4esNZWwqL1_tyxYzmNQ26z60YXYC0w/exec"; // â† å¿…ãšå¤‰æ›´
const token = "MIKOSHIYA_2026";

const device = "mikoshiya-ipad-entry";
const mode = "IN"; // â˜…ã“ã“ãŒè¶…é‡è¦ï¼ˆç¥­ã‚Šå‚åŠ ï¼INï¼‰

/* ========= å‹•ä½œè¨­å®š ========= */

const OK_LOCK_MS = 3500;
const FAIL_LOCK_MS = 1200;
const SCAN_INTERVAL_MS = 120;
const DUP_GUARD_MS = 2500;

/* ========= DOM ========= */

const video = document.getElementById("video");
const msg = document.getElementById("msg");
const btnSound = document.getElementById("enableSound");

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d",{willReadFrequently:true});

/* ========= çŠ¶æ…‹ ========= */

let sending=false;
let lockUntil=0;
let lastId="";
let lastIdAt=0;

/* ========= éŸ³ ========= */

let audioCtx=null;

btnSound.onclick=()=>{
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  btnSound.style.display="none";
};

function beep(freq=880,duration=0.1){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value=freq;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+duration);
  osc.stop(audioCtx.currentTime+duration);
}

/* ========= ã‚«ãƒ¡ãƒ© ========= */

navigator.mediaDevices.getUserMedia({
  video:{facingMode:"environment"}
})
.then(stream=>{
  video.srcObject=stream;
  video.play();
  requestAnimationFrame(scanLoop);
});

/* ========= QRã‚¹ã‚­ãƒ£ãƒ³ ========= */

function scanLoop(){

  if(Date.now()<lockUntil){
    requestAnimationFrame(scanLoop);
    return;
  }

  if(video.readyState===video.HAVE_ENOUGH_DATA){

    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);

    const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(imageData.data,canvas.width,canvas.height);

    if(code){
      const id=code.data.trim();

      if(id===lastId && Date.now()-lastIdAt<DUP_GUARD_MS){
        requestAnimationFrame(scanLoop);
        return;
      }

      lastId=id;
      lastIdAt=Date.now();

      send(id);
    }
  }

  setTimeout(()=>requestAnimationFrame(scanLoop),SCAN_INTERVAL_MS);
}

/* ========= GASé€ä¿¡ ========= */

async function send(id){

  if(sending) return;
  sending=true;

  msg.textContent="é€ä¿¡ä¸­...";

  try{

    const url=`${scriptUrl}?id=${encodeURIComponent(id)}&mode=${mode}&token=${token}&device=${device}`;
    const res=await fetch(url);
    const data=await res.json();

    if(data.ok){

      beep(1200,0.15);

      msg.innerHTML=`
      <div class="ok">
      ${id} ã•ã‚“<br>
      ã‚ˆã†ã“ãï¼<br>
      å…¥å®¤ã—ã¾ã—ãŸ
      </div>
      `;

      lockUntil=Date.now()+OK_LOCK_MS;

    }else{

      beep(300,0.3);
      msg.textContent=data.message;
      lockUntil=Date.now()+FAIL_LOCK_MS;
    }

  }catch(e){
    msg.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    lockUntil=Date.now()+FAIL_LOCK_MS;
  }

  sending=false;
}

/* ========= è‡ªå‹•ãƒˆãƒƒãƒ—å¾©å¸° ========= */

setInterval(()=>{
  if(Date.now()>lockUntil){
    msg.textContent="QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
  }
},500);

</script>

</body>
</html>
