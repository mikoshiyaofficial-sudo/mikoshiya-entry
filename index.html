 <!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜ v3 - è‡ªå‹•å…¥é€€å®¤</title>

  <!-- jsQRï¼ˆQRè§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --red:#d44747;
      --text:#111;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
      text-align:center;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:22px 12px 8px; }
    h1{ margin:0; font-size:40px; font-weight:900; letter-spacing:.02em; }
    h2{ margin:10px 0 0; font-size:30px; font-weight:1000; color:var(--red); }

    .frame{
      width:min(92vw, 980px);
      aspect-ratio: 4 / 3;
      margin:14px auto 10px;
      border:6px solid var(--red);
      border-radius:16px;
      overflow:hidden;
      background:#111;
      box-sizing:border-box;
      position:relative;
    }

    /* videoãŒã‚¿ãƒƒãƒ—ã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    #video{
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
    }

    #msg{
      font-size:18px;
      font-weight:900;
      margin-top:6px;
    }
    #sub{
      font-size:16px;
      font-weight:800;
      color:#444;
      margin-top:4px;
      min-height:24px;
    }

    #enableSound{
      margin:14px auto 8px;
      padding:16px 18px;
      font-size:22px;
      font-weight:900;
      border:0;
      border-radius:14px;
      background:#111;
      color:#fff;
      width:min(70vw, 520px);
      position:relative;
      z-index:9999;
    }
    #enableSound[disabled]{ opacity:.55; }

    .saleRow{
      width:min(92vw, 980px);
      margin:10px auto 0;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .saleBtn{
      padding:14px 16px;
      font-size:18px;
      font-weight:900;
      border:0;
      border-radius:12px;
      background:#fff;
      color:#111;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .saleBtn:active{ transform: translateY(1px); }

    #ver{
      position:fixed;
      right:10px;
      top:10px;
      font-size:12px;
      color:#888;
      font-weight:800;
    }

    /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆå¸¸ã«å‡ºã™ï¼‰ */
    #debug{
      display:block;
      width:min(92vw, 980px);
      margin:8px auto 16px;
      font-size:12px;
      color:#666;
      word-break:break-all;
      text-align:left;
    }
  </style>
</head>

<body>
  <div id="ver">v3</div>

  <header>
    <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>
    <h2>è‡ªå‹• å…¥é€€å®¤</h2>
  </header>

  <div class="frame">
    <video id="video" playsinline muted></video>
  </div>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <div id="sub"></div>

  <button id="enableSound">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

  <div class="saleRow">
    <button class="saleBtn" id="saleDrink">ç‰©è²©ï¼šãƒ‰ãƒªãƒ³ã‚¯ï¼ˆä¾‹ 150å††ï¼‰</button>
    <button class="saleBtn" id="saleSnack">ç‰©è²©ï¼šãŠè“å­ï¼ˆä¾‹ 100å††ï¼‰</button>
  </div>

  <div id="debug"></div>

  <script>
    /********************
     * è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚‹ï¼‰
     ********************/
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyoH2eou4zXvI-O4nhIZ3p7dLRVqu8CXwiCvxyRv_At3GfafxFU-8J-KboSTmYJlG4QFg/exec";
    const token  = "MIKOSHIYA_2026";
    const device = "mikoshiya-ipad-v3";

    /********************
     * å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     ********************/
    const OK_LOCK_MS       = 3500;
    const FAIL_LOCK_MS     = 1600;
    const SCAN_INTERVAL_MS = 120;
    const DUP_GUARD_MS     = 20000; // 20ç§’ åŒã˜QRé€£æ‰“é˜²æ­¢

    /********************
     * DOM
     ********************/
    const video = document.getElementById("video");
    const msg   = document.getElementById("msg");
    const sub   = document.getElementById("sub");
    const btnSound = document.getElementById("enableSound");
    const debug = document.getElementById("debug");

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently:true });

    /********************
     * çŠ¶æ…‹
     ********************/
    let sending = false;
    let lockUntil = 0;
    let lastId = "";
    let lastIdAt = 0;

    /********************
     * åŠ¹æœéŸ³
     ********************/
    const soundTaiko  = new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_2a2d7e0e86.mp3?filename=drum-hit-1-19943.mp3");
    const soundHanabi = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_2f5c0a6a66.mp3?filename=success-1-6297.mp3");
    soundTaiko.preload = "auto";
    soundHanabi.preload = "auto";
    soundTaiko.volume = 0.9;
    soundHanabi.volume = 0.9;

    let soundEnabled = false;

    // iPad Safariå¯¾ç­–ï¼šç„¡éŸ³â†’æœ¬éŸ³æºã‚’ä¸€åº¦ã ã‘é³´ã‚‰ã—ã¦è§£ç¦
    async function unlockSound(){
      const silentWav = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=";
      const silent = new Audio(silentWav);
      silent.volume = 0;
      await silent.play();

      soundTaiko.volume = 0.001;
      soundHanabi.volume = 0.001;

      soundTaiko.currentTime = 0;
      await soundTaiko.play();
      soundTaiko.pause();
      soundTaiko.currentTime = 0;

      soundHanabi.currentTime = 0;
      await soundHanabi.play();
      soundHanabi.pause();
      soundHanabi.currentTime = 0;

      soundTaiko.volume = 0.9;
      soundHanabi.volume = 0.9;

      soundEnabled = true;
      btnSound.textContent = "âœ… éŸ³ æœ‰åŠ¹";
      btnSound.disabled = true;
    }

    function playTaikoAndHanabi(){
      if(!soundEnabled) return;
      try{
        soundTaiko.currentTime = 0;
        soundTaiko.play().catch(()=>{});
        setTimeout(()=>{
          soundHanabi.currentTime = 0;
          soundHanabi.play().catch(()=>{});
        }, 180);
      }catch(_){}
    }

    function playNG(){
      if(!soundEnabled) return;
      try{
        soundTaiko.currentTime = 0;
        soundTaiko.play().catch(()=>{});
      }catch(_){}
    }

    btnSound.addEventListener("click", async ()=>{
      try{
        debug.textContent = "AUDIO: try unlock...";
        await unlockSound();
        debug.textContent = "AUDIO: unlocked âœ…";
        playTaikoAndHanabi();
      }catch(e){
        debug.textContent = "AUDIO ERROR: " + (e?.name || "") + " / " + (e?.message || e);
        msg.textContent = "éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—";
        sub.textContent = "ä¸‹ã® AUDIO ERROR ã‚’è¦‹ã¦ã­";
      }
    });

    /********************
     * ã‚«ãƒ¡ãƒ©èµ·å‹•
     ********************/
    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play(); // â†ã“ã“ã¯ [video.play] ã˜ã‚ƒãªãã¦ video.play()
    }

    /********************
     * QRèª­ã‚€
     ********************/
    function readQR(){
      if(video.readyState < 2) return null;
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h) return null;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);

      const img = ctx.getImageData(0,0,w,h);
      const code = jsQR(img.data, w, h, { inversionAttempts:"attemptBoth" });
      return code ? (code.data || "") : null;
    }

    function extractId(text){
      text = String(text||"").trim();
      if(!text) return "";

      if (/^[A-Za-z0-9_-]{3,}$/.test(text) && !text.includes("http")) return text;

      try{
        const u = new URL(text);
        const id = (u.searchParams.get("id") || u.searchParams.get("ID") || "").trim();
        if(id) return id;
      }catch(_){}

      const m = text.match(/[?&]id=([^&]+)/i);
      return m ? decodeURIComponent(m[1]).trim() : "";
    }

    /********************
     * è¡¨ç¤º helper
     ********************/
    function showInOk(id){
      msg.innerHTML = `<span style="font-size:36px;font-weight:1000">${esc(id)} ã•ã‚“</span>`;
      sub.innerHTML = `<div style="font-size:20px;font-weight:900;color:#444">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ å…¥å®¤OK</div>`;
    }
    function showOutOk(id, minutes, amount){
      msg.innerHTML = `<div style="font-size:34px;font-weight:1000">${esc(id)} ã•ã‚“</div>`;
      sub.innerHTML =
        `<div style="font-size:20px;font-weight:900;color:#444;margin-top:6px">é€€å®¤OK ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>` +
        `<div style="font-size:22px;font-weight:900;margin-top:8px">åˆ©ç”¨æ™‚é–“ï¼š${minutes} åˆ†</div>` +
        `<div style="font-size:36px;font-weight:1000;color:#d44747;margin-top:6px">æ–™é‡‘ï¼š${amount} å††</div>`;
    }
    function showError(title, detail){
      msg.textContent = title;
      sub.textContent = detail || "";
    }
    function esc(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /********************
     * é€ä¿¡ï¼ˆè‡ªå‹•IN/OUTï¼‰
     ********************/
    async function sendAuto(id){
      const now = Date.now();
      if(sending || now < lockUntil) return;

      if(id === lastId && (now - lastIdAt) < DUP_GUARD_MS) return;
      lastId = id;
      lastIdAt = now;

      sending = true;
      msg.textContent = "é€šä¿¡ä¸­â€¦";
      sub.textContent = "";

      const url =
        `${scriptUrl}` +
        `?id=${encodeURIComponent(id)}` +
        `&token=${encodeURIComponent(token)}` +
        `&device=${encodeURIComponent(device)}` +
        `&t=${Date.now()}`;

      try{
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        if(!data || data.ok !== true) throw new Error(data?.message || "unknown");

        if(data.action === "IN"){
          showInOk(id);
          playTaikoAndHanabi();
          lockUntil = Date.now() + OK_LOCK_MS;
        }else if(data.action === "OUT"){
          const minutes = Number(data.minutes ?? 0);
          const amount  = Number(data.amount ?? 0);
          showOutOk(id, minutes, amount);
          playTaikoAndHanabi();
          lockUntil = Date.now() + OK_LOCK_MS;
        }else{
          showError("é€šä¿¡çµæœãŒä¸æ˜", JSON.stringify(data));
          playNG();
          lockUntil = Date.now() + FAIL_LOCK_MS;
        }

      }catch(e){
        showError("é€šä¿¡å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­", (e?.message || e));
        playNG();
        lockUntil = Date.now() + FAIL_LOCK_MS;

      }finally{
        setTimeout(()=>{ sending = false; }, 350);
      }
    }

    /********************
     * ç‰©è²©é€ä¿¡ï¼ˆSALEï¼‰
     ********************/
    async function sendSale(amount, item){
      const now = Date.now();
      if(sending || now < lockUntil) return;

      sending = true;
      msg.textContent = "é€šä¿¡ä¸­â€¦";
      sub.textContent = "";

      const url =
        `${scriptUrl}` +
        `?action=SALE` +
        `&amount=${encodeURIComponent(amount)}` +
        `&item=${encodeURIComponent(item)}` +
        `&token=${encodeURIComponent(token)}` +
        `&device=${encodeURIComponent(device)}` +
        `&t=${Date.now()}`;

      try{
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        if(!data || data.ok !== true) throw new Error(data?.message || "unknown");

        msg.textContent = "ç‰©è²©OK";
        sub.textContent = `${item} / ${amount}å††`;
        playTaikoAndHanabi();
        lockUntil = Date.now() + OK_LOCK_MS;

      }catch(e){
        showError("ç‰©è²© é€šä¿¡å¤±æ•—", (e?.message || e));
        playNG();
        lockUntil = Date.now() + FAIL_LOCK_MS;

      }finally{
        setTimeout(()=>{ sending = false; }, 350);
      }
    }

    document.getElementById("saleDrink").addEventListener("click", ()=>sendSale(150, "drink"));
    document.getElementById("saleSnack").addEventListener("click", ()=>sendSale(100, "snack"));

    /********************
     * ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ—
     ********************/
    function loop(){
      const now = Date.now();

      if(now < lockUntil){
        requestAnimationFrame(loop);
        return;
      }

      if(msg.textContent !== "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„" && !sending){
        msg.textContent = "QRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
        sub.textContent = "";
      }

      const raw = readQR();
      if(raw){
        const id = extractId(raw);
        if(id) sendAuto(id);
      }

      setTimeout(()=>requestAnimationFrame(loop), SCAN_INTERVAL_MS);
    }

    /********************
     * èµ·å‹•
     ********************/
    (async ()=>{
      try{
        debug.textContent = "BOOT: starting camera...";
        await startCamera();
        debug.textContent = "BOOT: camera OK / press sound button";
        requestAnimationFrame(loop);
      }catch(e){
        msg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼ˆè¨±å¯ã‚’ç¢ºèªï¼‰";
        sub.textContent = (e?.message || e);
        debug.textContent = "CAMERA ERROR: " + (e?.name || "") + " / " + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
